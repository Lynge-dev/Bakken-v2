<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Håndæg og Håndbajere - Billeder</title>
    <link rel="stylesheet" href="photos-styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">🏈 Håndæg og Håndbajere</h1>
            <p class="app-subtitle">Billeder & Minder</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">🔄</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Navigation -->
        <section class="navigation-section">
            <a href="games.html" class="nav-btn">← Tilbage til Spil</a>
        </section>

        <!-- Mode Selector -->
        <section class="mode-selector">
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="group">📸 Gruppe</button>
                <button class="mode-tab" data-mode="teams">🏈 Hold</button>
                <button class="mode-tab" data-mode="export">📤 Eksport</button>
            </div>
        </section>

        <!-- Group Photo Mode -->
        <div class="photo-mode active" id="groupMode">
            <section class="photo-card">
                <h2 class="section-title">📸 Gruppebillede</h2>
                
                <div class="photo-preview" id="groupPhotoPreview">
                    <div class="photo-placeholder" onclick="selectGroupPhoto()">
                        <div class="placeholder-icon">📸</div>
                        <p>Tilføj Gruppebillede</p>
                        <small>Klik for at vælge billede</small>
                    </div>
                </div>

                <div class="photo-info">
                    <h3>Alle Deltagere</h3>
                    <div class="participants-list" id="allParticipants">
                        <!-- Will be populated with all players -->
                    </div>
                </div>

                <div class="photo-actions">
                    <button class="photo-btn camera" onclick="takeGroupPhoto()">📷 Tag Billede</button>
                    <button class="photo-btn upload" onclick="selectGroupPhoto()">📁 Vælg Fil</button>
                    <button class="photo-btn delete" onclick="deleteGroupPhoto()" id="deleteGroupBtn" style="display: none;">🗑️ Slet</button>
                </div>
            </section>
        </div>

        <!-- Team Photos Mode -->
        <div class="photo-mode" id="teamsMode">
            <div class="teams-photo-grid" id="teamsPhotoGrid">
                <!-- Team photo cards will be generated here -->
            </div>
        </div>

        <!-- Export Mode -->
        <div class="photo-mode" id="exportMode">
            <div class="export-options">
                <div class="export-card">
                    <h3>📱 Del Billeder</h3>
                    <p>Generer links til at dele alle billeder med deltagerne</p>
                    <button class="export-btn primary" onclick="generateShareLinks()">Generer Dele-Links</button>
                </div>

                <div class="export-card">
                    <h3>💾 Download Alle</h3>
                    <p>Download alle billeder som en ZIP-fil</p>
                    <button class="export-btn" onclick="downloadAllPhotos()">Download ZIP</button>
                </div>

                <div class="export-card">
                    <h3>📊 Eksporter Data</h3>
                    <p>Eksporter turnerings-data og resultater</p>
                    <button class="export-btn" onclick="exportTournamentData()">Eksporter Data</button>
                </div>
            </div>

            <div class="export-preview" id="exportPreview" style="display: none;">
                <h3>📋 Eksport Forhåndsvisning</h3>
                <div class="preview-content" id="previewContent">
                    <!-- Export content will be shown here -->
                </div>
                <div class="preview-actions">
                    <button class="export-btn" onclick="copyToClipboard()">📋 Kopier</button>
                    <button class="export-btn" onclick="downloadAsFile()">💾 Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Billede</h3>
                <button class="close-btn" onclick="closePhotoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="Billede">
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="groupPhotoInput" accept="image/*" style="display: none;" onchange="handleGroupPhotoSelect(event)">
    <input type="file" id="teamPhotoInput" accept="image/*" style="display: none;" onchange="handleTeamPhotoSelect(event)">

    <script>
        // Photos management with sync
        let teams = [];
        let players = [];
        let photos = {
            group: null,
            teams: {}
        };
        let currentTeamForPhoto = null;

        // DOM elements
        const modeTabs = document.querySelectorAll('.mode-tab');
        const photoModes = document.querySelectorAll('.photo-mode');
        const groupPhotoPreview = document.getElementById('groupPhotoPreview');
        const allParticipants = document.getElementById('allParticipants');
        const teamsPhotoGrid = document.getElementById('teamsPhotoGrid');
        const deleteGroupBtn = document.getElementById('deleteGroupBtn');
        const photoModal = document.getElementById('photoModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalImage = document.getElementById('modalImage');
        const exportPreview = document.getElementById('exportPreview');
        const previewContent = document.getElementById('previewContent');
        const syncStatus = document.getElementById('syncStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Photos page starting...');
            loadData();
            setupEventListeners();
            updateUI();
            updateSyncStatus();
            
            // Initialize sync
            setTimeout(() => {
                if (window.syncManager) {
                    window.syncManager.initialize().then(() => {
                        console.log('✅ Sync manager initialized');
                        loadData(); // Reload in case cloud data was merged
                        updateUI();
                        updateSyncStatus();
                    }).catch(error => {
                        console.error('❌ Sync initialization failed:', error);
                        updateSyncStatus();
                    });
                }
            }, 1000);
        });

        function loadData() {
            try {
                // Load players
                const playersData = localStorage.getItem('bakken-players');
                if (playersData) {
                    players = JSON.parse(playersData);
                    console.log('📥 Loaded players:', players);
                }

                // Load teams
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const savedData = JSON.parse(teamsData);
                    teams = savedData.teams || [];
                    console.log('📥 Loaded teams:', teams);
                }

                // Load photos
                const photosData = localStorage.getItem('bakken-photos');
                if (photosData) {
                    photos = JSON.parse(photosData);
                    console.log('📥 Loaded photos:', photos);
                }
            } catch (e) {
                console.error('❌ Load failed:', e);
                photos = { group: null, teams: {} };
            }
        }

        function saveData() {
            try {
                const photosData = {
                    ...photos,
                    lastUpdated: Date.now()
                };
                
                localStorage.setItem('bakken-photos', JSON.stringify(photosData));
                localStorage.setItem('bakken-photos-last-update', Date.now().toString());
                console.log('💾 Saved photos data');
                
                // Note: Photos are stored locally only due to size constraints
                // In a real app, you'd upload to cloud storage
                showMessage('📸 Billeder gemt lokalt', '#4ECDC4');
            } catch (e) {
                console.error('❌ Save failed:', e);
                showMessage('❌ Fejl ved gemning af billeder', '#FF6B6B');
            }
        }

        function setupEventListeners() {
            // Mode tabs
            modeTabs.forEach(tab => {
                tab.addEventListener('click', () => switchMode(tab.dataset.mode));
            });

            // Modal close
            photoModal.addEventListener('click', (e) => {
                if (e.target === photoModal) closePhotoModal();
            });

            // Listen for sync status changes
            window.addEventListener('sync-status-changed', function(event) {
                console.log('📊 Sync status changed:', event.detail.status);
                updateSyncStatus();
            });

            // Update sync status periodically
            setInterval(updateSyncStatus, 3000);
        }

        function updateUI() {
            updateAllParticipants();
            updateGroupPhoto();
            updateTeamsPhotos();
        }

        function updateAllParticipants() {
            if (players.length === 0) {
                allParticipants.innerHTML = '<p>Ingen spillere fundet</p>';
                return;
            }

            allParticipants.innerHTML = players.map(player => escapeHtml(player.name)).join(', ');
        }

        function updateGroupPhoto() {
            if (photos.group) {
                groupPhotoPreview.innerHTML = `
                    <img src="${photos.group}" alt="Gruppebillede" onclick="openPhotoModal('Gruppebillede', '${photos.group}')">
                `;
                deleteGroupBtn.style.display = 'inline-block';
            } else {
                groupPhotoPreview.innerHTML = `
                    <div class="photo-placeholder" onclick="selectGroupPhoto()">
                        <div class="placeholder-icon">📸</div>
                        <p>Tilføj Gruppebillede</p>
                        <small>Klik for at vælge billede</small>
                    </div>
                `;
                deleteGroupBtn.style.display = 'none';
            }
        }

        function updateTeamsPhotos() {
            if (teams.length === 0) {
                teamsPhotoGrid.innerHTML = '<p>Ingen hold fundet</p>';
                return;
            }

            teamsPhotoGrid.innerHTML = teams.map((team, index) => `
                <div class="team-photo-card">
                    <div class="team-photo-preview">
                        ${photos.teams[team.id] ? 
                            `<img src="${photos.teams[team.id]}" alt="${escapeHtml(team.name)}" onclick="openPhotoModal('${escapeHtml(team.name)}', '${photos.teams[team.id]}')">` :
                            `<div class="team-photo-placeholder" onclick="selectTeamPhoto(${team.id})">📸</div>`
                        }
                    </div>
                    <div class="team-photo-info">
                        <h3>
                            <div class="team-color-indicator team-${index + 1}-color"></div>
                            ${escapeHtml(team.name)}
                        </h3>
                        <div class="team-members">
                            ${team.players.map(p => escapeHtml(p.name)).join(', ')}
                        </div>
                    </div>
                    <div class="team-photo-actions">
                        <button class="team-photo-btn camera" onclick="takeTeamPhoto(${team.id})">📷</button>
                        <button class="team-photo-btn upload" onclick="selectTeamPhoto(${team.id})">📁</button>
                        ${photos.teams[team.id] ? 
                            `<button class="team-photo-btn delete" onclick="deleteTeamPhoto(${team.id})">🗑️</button>` : ''
                        }
                    </div>
                </div>
            `).join('');
        }

        function switchMode(mode) {
            // Update tabs
            modeTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });

            // Update modes
            photoModes.forEach(modeDiv => {
                modeDiv.classList.toggle('active', modeDiv.id === mode + 'Mode');
            });

            console.log('📱 Switched to mode:', mode);
        }

        // Photo functions
        function selectGroupPhoto() {
            document.getElementById('groupPhotoInput').click();
        }

        function selectTeamPhoto(teamId) {
            currentTeamForPhoto = teamId;
            document.getElementById('teamPhotoInput').click();
        }

        function takeGroupPhoto() {
            // In a real app, this would open camera
            alert('📷 Kamera funktionalitet ikke implementeret i demo.\nBrug "Vælg Fil" i stedet.');
        }

        function takeTeamPhoto(teamId) {
            // In a real app, this would open camera
            alert('📷 Kamera funktionalitet ikke implementeret i demo.\nBrug "Vælg Fil" i stedet.');
        }

        function handleGroupPhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos.group = e.target.result;
                    updateGroupPhoto();
                    saveData();
                    showMessage('📸 Gruppebillede tilføjet', '#4ECDC4');
                };
                reader.readAsDataURL(file);
            }
        }

        function handleTeamPhotoSelect(event) {
            const file = event.target.files[0];
            if (file && currentTeamForPhoto) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos.teams[currentTeamForPhoto] = e.target.result;
                    updateTeamsPhotos();
                    saveData();
                    
                    const team = teams.find(t => t.id === currentTeamForPhoto);
                    showMessage(`📸 Billede tilføjet til ${team.name}`, '#4ECDC4');
                    currentTeamForPhoto = null;
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteGroupPhoto() {
            if (confirm('Slet gruppebillede?')) {
                photos.group = null;
                updateGroupPhoto();
                saveData();
                showMessage('🗑️ Gruppebillede slettet', '#FF9A42');
            }
        }

        function deleteTeamPhoto(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (confirm(`Slet billede af ${team.name}?`)) {
                delete photos.teams[teamId];
                updateTeamsPhotos();
                saveData();
                showMessage(`🗑️ ${team.name} billede slettet`, '#FF9A42');
            }
        }

        function openPhotoModal(title, imageSrc) {
            modalTitle.textContent = title;
            modalImage.src = imageSrc;
            photoModal.classList.add('active');
        }

        function closePhotoModal() {
            photoModal.classList.remove('active');
        }

        // Export functions
        function generateShareLinks() {
            const hasPhotos = photos.group || Object.keys(photos.teams).length > 0;
            
            if (!hasPhotos) {
                alert('📸 Ingen billeder at dele endnu');
                return;
            }

            const shareData = {
                tournament: 'Håndæg og Håndbajere',
                date: new Date().toLocaleDateString('da-DK'),
                photos: {
                    group: !!photos.group,
                    teams: Object.keys(photos.teams).length
                }
            };

            const shareText = `🏈 Håndæg og Håndbajere - ${shareData.date}\n\n📸 Billeder tilgængelige:\n${photos.group ? '✅ Gruppebillede\n' : ''}${Object.keys(photos.teams).length > 0 ? `✅ ${Object.keys(photos.teams).length} holdbilleder\n` : ''}\n🔗 Link: ${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Håndæg og Håndbajere - Billeder',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('📋 Dele-tekst kopieret til udklipsholder', '#4ECDC4');
                });
            }
        }

        function downloadAllPhotos() {
            alert('💾 Download funktionalitet ikke implementeret i demo.\nBilleder er gemt lokalt i browseren.');
        }

        function exportTournamentData() {
            const data = {
                tournament: 'Håndæg og Håndbajere',
                date: new Date().toISOString(),
                players: players,
                teams: teams,
                games: JSON.parse(localStorage.getItem('bakken-games') || '{"games": []}').games,
                photos: {
                    hasGroup: !!photos.group,
                    teamPhotos: Object.keys(photos.teams).length
                }
            };

            const exportText = JSON.stringify(data, null, 2);
            
            previewContent.textContent = exportText;
            exportPreview.style.display = 'block';
            
            showMessage('📊 Data eksporteret', '#4ECDC4');
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(previewContent.textContent).then(() => {
                showMessage('📋 Data kopieret til udklipsholder', '#4ECDC4');
            });
        }

        function downloadAsFile() {
            const data = previewContent.textContent;
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bakken-turnering-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('💾 Fil downloadet', '#4ECDC4');
        }

        function updateSyncStatus() {
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (!status.initialized) {
                    statusIndicator.textContent = '🔄';
                    statusText.textContent = 'Connecting...';
                    syncStatus.style.background = 'rgba(255, 179, 102, 0.3)';
                } else if (!status.hasSupabase) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                } else if (!status.online) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else if (status.pendingSync > 0) {
                    statusIndicator.textContent = '⏳';
                    statusText.textContent = `Syncing ${status.pendingSync}...`;
                    syncStatus.style.background = 'rgba(69, 183, 209, 0.3)';
                } else if (status.hasSupabase && status.online) {
                    statusIndicator.textContent = '☁️';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = '📱';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) existingMessage.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideUp 0.3s ease forwards';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add animations
        if (!document.getElementById('photos-animations')) {
            const animationStyle = document.createElement('style');
            animationStyle.id = 'photos-animations';
            animationStyle.textContent = `
                @keyframes slideDown {
                    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    to { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
                
                @keyframes slideUp {
                    from { opacity: 1; transform: translateX(-50%) translateY(0); }
                    to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(animationStyle);
        }

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function() {
            if (photos.group || Object.keys(photos.teams).length > 0) {
                saveData();
            }
        });
    </script>
</body>
</html>