<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√•nd√¶g og H√•ndbajere - Spillere</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">üèà H√•nd√¶g og H√•ndbajere</h1>
            <p class="app-subtitle">Tilf√∏j Spillere</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Player Input -->
        <section class="input-section">
            <div class="input-group">
                <input type="text" id="playerInput" placeholder="Indtast spillernavn" maxlength="30">
                <button id="addPlayerBtn" class="add-btn">
                    Tilf√∏j Spiller
                </button>
            </div>
        </section>

        <!-- Players List -->
        <section class="players-section">
            <h2 class="section-title">
                Spillere 
                <span class="player-count" id="playerCount">0</span>
            </h2>
            <div class="players-list" id="playersList">
                <p class="empty-message">Ingen spillere tilf√∏jet endnu</p>
            </div>
        </section>

        <!-- Actions -->
        <section class="actions-section">
            <button id="clearAllBtn" class="action-btn secondary">
                üóëÔ∏è Ryd Alle
            </button>
            <a href="simple-teams.html" id="continueBtn" class="action-btn primary disabled">
                N√¶ste: Opret Hold
            </a>
        </section>
    </div>

    <script>
        // Enhanced player management with sync
        let players = [];

        // DOM elements
        const playerInput = document.getElementById('playerInput');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const continueBtn = document.getElementById('continueBtn');
        const syncStatus = document.getElementById('syncStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Players page starting...');
            loadPlayers();
            setupEventListeners();
            updateUI();
            updateSyncStatus();
            
            // Initialize sync with delay to ensure Supabase is loaded
            setTimeout(() => {
                if (window.syncManager) {
                    window.syncManager.initialize().then(() => {
                        console.log('‚úÖ Sync manager initialized');
                        loadPlayers(); // Reload in case cloud data was merged
                        updateUI();
                        updateSyncStatus();
                    }).catch(error => {
                        console.error('‚ùå Sync initialization failed:', error);
                        updateSyncStatus();
                    });
                } else {
                    console.warn('‚ö†Ô∏è Sync manager not available');
                    updateSyncStatus();
                }
            }, 1000);
        });

        function loadPlayers() {
            try {
                const data = localStorage.getItem('bakken-players');
                if (data) {
                    players = JSON.parse(data);
                    console.log('üì• Loaded players:', players);
                } else {
                    players = [];
                }
            } catch (e) {
                console.error('‚ùå Load failed:', e);
                players = [];
            }
        }

        function savePlayers() {
            try {
                localStorage.setItem('bakken-players', JSON.stringify(players));
                localStorage.setItem('bakken-players-last-update', Date.now().toString());
                console.log('üíæ Saved players locally:', players);
                
                // Sync to cloud
                if (window.syncManager && window.syncManager.isInitialized) {
                    window.syncManager.syncPlayers(players);
                } else {
                    console.log('üìù Sync manager not ready, data saved locally only');
                }
            } catch (e) {
                console.error('‚ùå Save failed:', e);
            }
        }

        function setupEventListeners() {
            addPlayerBtn.addEventListener('click', addPlayer);
            clearAllBtn.addEventListener('click', clearAllPlayers);
            
            playerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
            
            playerInput.addEventListener('input', function() {
                addPlayerBtn.disabled = this.value.trim().length === 0;
            });

            // Listen for remote data updates
            window.addEventListener('bakken-data-updated', function(event) {
                if (event.detail.table === 'players' && event.detail.source === 'remote') {
                    console.log('üîÑ Players updated from remote source');
                    loadPlayers();
                    updateUI();
                    showMessage('üîÑ Players updated from another device', '#45B7D1');
                }
            });

            // Listen for data loaded from cloud
            window.addEventListener('bakken-data-loaded', function() {
                console.log('üì• Data loaded from cloud');
                loadPlayers();
                updateUI();
            });

            // Listen for sync status changes
            window.addEventListener('sync-status-changed', function(event) {
                console.log('üìä Sync status changed:', event.detail.status);
                updateSyncStatus();
            });

            // Update sync status periodically
            setInterval(updateSyncStatus, 5000);
        }

        function addPlayer() {
            const name = playerInput.value.trim();
            
            if (name === '') {
                alert('Indtast et navn');
                return;
            }
            
            if (players.some(player => player.name.toLowerCase() === name.toLowerCase())) {
                alert('Spilleren findes allerede');
                return;
            }
            
            const newPlayer = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                name: name
            };
            
            players.push(newPlayer);
            console.log('‚ûï Added player:', newPlayer);
            
            playerInput.value = '';
            addPlayerBtn.disabled = true;
            
            savePlayers();
            updateUI();
            showMessage(`${name} tilf√∏jet!`, '#4ECDC4');
        }

        function removePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && confirm(`Fjern ${player.name}?`)) {
                players = players.filter(p => p.id !== playerId);
                savePlayers();
                updateUI();
                showMessage(`${player.name} fjernet`, '#FF9A42');
            }
        }

        function clearAllPlayers() {
            if (players.length === 0) return;
            
            if (confirm(`Fjern alle ${players.length} spillere?`)) {
                players = [];
                savePlayers();
                updateUI();
                showMessage('Alle spillere fjernet', '#FF9A42');
            }
        }

        function updateUI() {
            updatePlayersList();
            updatePlayerCount();
            updateContinueButton();
        }

        function updatePlayersList() {
            if (players.length === 0) {
                playersList.innerHTML = '<p class="empty-message">Ingen spillere tilf√∏jet endnu</p>';
                return;
            }
            
            playersList.innerHTML = players.map(player => `
                <div class="player-item">
                    <span class="player-name">${escapeHtml(player.name)}</span>
                    <button class="remove-btn" onclick="removePlayer('${player.id}')">√ó</button>
                </div>
            `).join('');
        }

        function updatePlayerCount() {
            playerCount.textContent = players.length;
        }

        function updateContinueButton() {
            if (players.length >= 3) {
                continueBtn.classList.remove('disabled');
                continueBtn.style.pointerEvents = 'auto';
            } else {
                continueBtn.classList.add('disabled');
                continueBtn.style.pointerEvents = 'none';
            }
        }

        function updateSyncStatus() {
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (!status.initialized) {
                    statusIndicator.textContent = 'üîÑ';
                    statusText.textContent = 'Connecting...';
                    syncStatus.style.background = 'rgba(255, 179, 102, 0.3)';
                } else if (!status.hasSupabase) {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                } else if (!status.online) {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else if (status.pendingSync > 0) {
                    statusIndicator.textContent = '‚è≥';
                    statusText.textContent = `Syncing ${status.pendingSync}...`;
                    syncStatus.style.background = 'rgba(69, 183, 209, 0.3)';
                } else {
                    statusIndicator.textContent = '‚òÅÔ∏è';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                }
            } else {
                statusIndicator.textContent = 'üì±';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            // Remove existing message
            const existingMessage = document.querySelector('.message');
            if (existingMessage) existingMessage.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideUp 0.3s ease forwards';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            
            @keyframes slideUp {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
            
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100px); }
                to { opacity: 1; transform: translateX(0); }
            }
        `;
        document.head.appendChild(style);

        // Debug function for testing
        window.debugSync = function() {
            console.log('üîç Debug Sync Status:');
            if (window.syncManager) {
                console.log('Sync Manager:', window.syncManager.getStatus());
                console.log('Tournament ID:', window.syncManager.tournamentId);
                console.log('Supabase Client:', !!window.syncManager.supabase);
            } else {
                console.log('‚ùå Sync Manager not available');
            }
            console.log('Players:', players);
            console.log('Local Storage:', {
                players: localStorage.getItem('bakken-players'),
                tournamentId: localStorage.getItem('bakken-tournament-id')
            });
        };

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function() {
            if (players.length > 0) {
                savePlayers();
            }
        });

        // Handle visibility change (mobile app switching)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Page became visible again, check for updates
                if (window.syncManager && window.syncManager.isInitialized) {
                    updateSyncStatus();
                }
            }
        });
    </script>
</body>
</html>