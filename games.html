<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Håndæg og Håndbajere - Spil</title>
    <link rel="stylesheet" href="games-styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">🏈 Håndæg og Håndbajere</h1>
            <p class="app-subtitle">Spil & Resultater</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">🔄</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Navigation -->
        <section class="navigation-section">
            <a href="simple-teams.html" class="nav-btn">← Tilbage til Hold</a>
            <a href="photos.html" class="nav-btn primary">📸 Billeder</a>
        </section>

        <!-- Game Views -->
        <div class="game-view" id="gameView">
            <!-- Standings Section -->
            <section class="standings-section">
                <h2 class="section-title">🏆 Stilling</h2>
                <div class="standings-grid" id="standingsGrid">
                    <!-- Standings will be generated here -->
                </div>
            </section>

            <!-- Add Game Section -->
            <section class="add-game-section" id="addGameSection">
                <div class="add-game-card">
                    <h3 class="section-title">➕ Tilføj Spil Resultat</h3>
                    <div class="input-group" id="gameInputs">
                        <!-- Game inputs will be generated here -->
                    </div>
                    <button id="addGameBtn" class="add-game-btn" disabled>
                        Tilføj Resultat
                    </button>
                    <p class="add-game-hint">Indtast placeringer for alle hold</p>
                </div>
            </section>

            <!-- Completed Games Section -->
            <section class="completed-section">
                <h2 class="section-title">
                    Afsluttede Spil 
                    <span class="completed-badge" id="completedCount">0</span>
                </h2>
                <div class="completed-games" id="completedGames">
                    <p class="no-games">Ingen spil afsluttet endnu</p>
                </div>
            </section>

            <!-- Finish Section -->
            <section class="finish-section">
                <button id="finishBtn" class="finish-btn" disabled>
                    🏁 Afslut Turnering
                </button>
                <p class="finish-hint">Spil mindst 3 spil for at afslutte</p>
            </section>
        </div>

        <!-- Active Game View -->
        <div class="active-game-section" id="activeGameView" style="display: none;">
            <h2 class="game-title" id="gameTitle">Spil Resultat</h2>
            
            <div class="winner-selection">
                <h3>Vælg placeringer:</h3>
                
                <div class="winner-card">
                    <div class="place-header">
                        <span class="place-medal">🥇</span>
                        <h4>1. Plads (3 point)</h4>
                    </div>
                    <div class="team-buttons" id="firstPlaceButtons">
                        <!-- Team buttons will be generated here -->
                    </div>
                </div>

                <div class="winner-card">
                    <div class="place-header">
                        <span class="place-medal">🥈</span>
                        <h4>2. Plads (2 point)</h4>
                    </div>
                    <div class="team-buttons" id="secondPlaceButtons">
                        <!-- Team buttons will be generated here -->
                    </div>
                </div>

                <div class="winner-card">
                    <div class="place-header">
                        <span class="place-medal">🥉</span>
                        <h4>3. Plads (1 point)</h4>
                    </div>
                    <div class="team-buttons" id="thirdPlaceButtons">
                        <!-- Team buttons will be generated here -->
                    </div>
                </div>
            </div>

            <div class="game-actions">
                <button id="saveGameBtn" class="action-btn primary" disabled>
                    💾 Gem Resultat
                </button>
                <button id="cancelGameBtn" class="action-btn secondary">
                    ❌ Annuller
                </button>
            </div>
        </div>
    </div>

    <script>
        // Games management with sync
        let teams = [];
        let games = [];
        let currentGame = null;
        let gameCounter = 1;

        // DOM elements
        const standingsGrid = document.getElementById('standingsGrid');
        const gameInputs = document.getElementById('gameInputs');
        const addGameBtn = document.getElementById('addGameBtn');
        const completedGames = document.getElementById('completedGames');
        const completedCount = document.getElementById('completedCount');
        const finishBtn = document.getElementById('finishBtn');
        const gameView = document.getElementById('gameView');
        const activeGameView = document.getElementById('activeGameView');
        const gameTitle = document.getElementById('gameTitle');
        const firstPlaceButtons = document.getElementById('firstPlaceButtons');
        const secondPlaceButtons = document.getElementById('secondPlaceButtons');
        const thirdPlaceButtons = document.getElementById('thirdPlaceButtons');
        const saveGameBtn = document.getElementById('saveGameBtn');
        const cancelGameBtn = document.getElementById('cancelGameBtn');
        const syncStatus = document.getElementById('syncStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Games page starting...');
            loadData();
            setupEventListeners();
            updateUI();
            updateSyncStatus();
            
            // Initialize sync
            setTimeout(() => {
                if (window.syncManager) {
                    window.syncManager.initialize().then(() => {
                        console.log('✅ Sync manager initialized');
                        loadData(); // Reload in case cloud data was merged
                        updateUI();
                        updateSyncStatus();
                    }).catch(error => {
                        console.error('❌ Sync initialization failed:', error);
                        updateSyncStatus();
                    });
                }
            }, 1000);
        });

        function loadData() {
            try {
                // Load teams
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const savedData = JSON.parse(teamsData);
                    teams = savedData.teams || [];
                    console.log('📥 Loaded teams:', teams);
                }

                // Load games
                const gamesData = localStorage.getItem('bakken-games');
                if (gamesData) {
                    const savedData = JSON.parse(gamesData);
                    games = savedData.games || [];
                    gameCounter = savedData.gameCounter || 1;
                    console.log('📥 Loaded games:', games);
                }

                // Redirect if no teams
                if (teams.length === 0) {
                    alert('Ingen hold fundet. Opret hold først.');
                    window.location.href = 'simple-teams.html';
                    return;
                }
            } catch (e) {
                console.error('❌ Load failed:', e);
                alert('Fejl ved indlæsning af data. Gå tilbage til hold-siden.');
                window.location.href = 'simple-teams.html';
            }
        }

        function saveData() {
            try {
                const gamesData = {
                    games: games,
                    gameCounter: gameCounter,
                    lastUpdated: Date.now()
                };
                
                localStorage.setItem('bakken-games', JSON.stringify(gamesData));
                localStorage.setItem('bakken-games-last-update', Date.now().toString());
                console.log('💾 Saved games data:', gamesData);
                
                // Sync to cloud
                if (window.syncManager && window.syncManager.isInitialized) {
                    window.syncManager.syncGames(gamesData);
                } else {
                    console.log('📝 Sync manager not ready, data saved locally only');
                }
            } catch (e) {
                console.error('❌ Save failed:', e);
            }
        }

        function setupEventListeners() {
            addGameBtn.addEventListener('click', startNewGame);
            finishBtn.addEventListener('click', finishTournament);
            saveGameBtn.addEventListener('click', saveCurrentGame);
            cancelGameBtn.addEventListener('click', cancelCurrentGame);

            // Listen for remote data updates
            window.addEventListener('bakken-data-updated', function(event) {
                if (event.detail.table === 'games' && event.detail.source === 'remote') {
                    console.log('🔄 Games updated from remote source');
                    loadData();
                    updateUI();
                    showMessage('🔄 Games updated from another device', '#45B7D1');
                }
            });

            // Listen for data loaded from cloud
            window.addEventListener('bakken-data-loaded', function() {
                console.log('📥 Data loaded from cloud');
                loadData();
                updateUI();
            });

            // Listen for sync status changes
            window.addEventListener('sync-status-changed', function(event) {
                console.log('📊 Sync status changed:', event.detail.status);
                updateSyncStatus();
            });

            // Update sync status periodically
            setInterval(updateSyncStatus, 3000);
        }

        function updateUI() {
            updateStandings();
            updateGameInputs();
            updateCompletedGames();
            updateFinishButton();
        }

        function updateStandings() {
            const standings = calculateStandings();
            
            if (standings.length === 0) {
                standingsGrid.innerHTML = '<p class="no-games">Ingen resultater endnu</p>';
                return;
            }

            standingsGrid.innerHTML = standings.map((team, index) => `
                <div class="team-standing ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                    <span class="standing-position">${index + 1}</span>
                    <div class="standing-info">
                        <div class="standing-team">${escapeHtml(team.name)}</div>
                        <div class="standing-members">${team.players.map(p => p.name).join(', ')}</div>
                    </div>
                    <span class="standing-score">${team.score}</span>
                </div>
            `).join('');
        }

        function calculateStandings() {
            const teamScores = teams.map(team => ({
                ...team,
                score: 0
            }));

            games.forEach(game => {
                game.results.forEach(result => {
                    const team = teamScores.find(t => t.id === result.teamId);
                    if (team) {
                        team.score += result.points;
                    }
                });
            });

            return teamScores.sort((a, b) => b.score - a.score);
        }

        function updateGameInputs() {
            gameInputs.innerHTML = teams.map(team => `
                <input type="number" 
                       id="team${team.id}" 
                       placeholder="${escapeHtml(team.name)} placering" 
                       min="1" 
                       max="${teams.length}"
                       onchange="validateGameInputs()">
            `).join('');
        }

        function validateGameInputs() {
            const inputs = teams.map(team => {
                const input = document.getElementById(`team${team.id}`);
                return {
                    teamId: team.id,
                    teamName: team.name,
                    placement: parseInt(input.value) || 0
                };
            });

            const validPlacements = inputs.filter(input => input.placement > 0 && input.placement <= teams.length);
            const uniquePlacements = new Set(validPlacements.map(input => input.placement));
            
            const isValid = validPlacements.length === teams.length && uniquePlacements.size === teams.length;
            addGameBtn.disabled = !isValid;
        }

        function startNewGame() {
            const inputs = teams.map(team => {
                const input = document.getElementById(`team${team.id}`);
                return {
                    teamId: team.id,
                    teamName: team.name,
                    placement: parseInt(input.value)
                };
            });

            currentGame = {
                id: gameCounter,
                name: `Spil ${gameCounter}`,
                results: inputs.map(input => ({
                    teamId: input.teamId,
                    teamName: input.teamName,
                    placement: input.placement,
                    points: calculatePoints(input.placement, teams.length)
                }))
            };

            gameTitle.textContent = `${currentGame.name} - Bekræft Resultat`;
            updateActiveGameView();
            showActiveGameView();
        }

        function calculatePoints(placement, totalTeams) {
            return Math.max(1, totalTeams + 1 - placement);
        }

        function updateActiveGameView() {
            if (!currentGame) return;

            const sortedResults = [...currentGame.results].sort((a, b) => a.placement - b.placement);

            // Update place buttons
            updatePlaceButtons(firstPlaceButtons, sortedResults, 1);
            updatePlaceButtons(secondPlaceButtons, sortedResults, 2);
            updatePlaceButtons(thirdPlaceButtons, sortedResults, 3);

            saveGameBtn.disabled = false;
        }

        function updatePlaceButtons(container, results, placement) {
            const team = results.find(r => r.placement === placement);
            if (team) {
                container.innerHTML = `
                    <button class="team-btn selected" disabled>
                        ${escapeHtml(team.teamName)} (${team.points} point)
                    </button>
                `;
            } else {
                container.innerHTML = '<p>Ingen hold på denne plads</p>';
            }
        }

        function saveCurrentGame() {
            if (!currentGame) return;

            games.push(currentGame);
            gameCounter++;
            
            // Clear inputs
            teams.forEach(team => {
                const input = document.getElementById(`team${team.id}`);
                if (input) input.value = '';
            });

            saveData();
            updateUI();
            hideActiveGameView();
            showMessage(`${currentGame.name} gemt!`, '#4ECDC4');
            currentGame = null;
        }

        function cancelCurrentGame() {
            currentGame = null;
            hideActiveGameView();
        }

        function showActiveGameView() {
            gameView.style.display = 'none';
            activeGameView.style.display = 'block';
        }

        function hideActiveGameView() {
            gameView.style.display = 'block';
            activeGameView.style.display = 'none';
        }

        function updateCompletedGames() {
            completedCount.textContent = games.length;

            if (games.length === 0) {
                completedGames.innerHTML = '<p class="no-games">Ingen spil afsluttet endnu</p>';
                return;
            }

            completedGames.innerHTML = games.map(game => `
                <div class="completed-game">
                    <div class="completed-game-info">
                        <div class="completed-game-name">${escapeHtml(game.name)}</div>
                        <div class="completed-game-result">
                            ${game.results.sort((a, b) => a.placement - b.placement)
                                .map(r => `${r.placement}. ${r.teamName} (${r.points}p)`)
                                .join(' • ')}
                        </div>
                    </div>
                    <button class="delete-game-btn" onclick="deleteGame(${game.id})">🗑️</button>
                </div>
            `).join('');
        }

        function deleteGame(gameId) {
            const game = games.find(g => g.id === gameId);
            if (game && confirm(`Slet ${game.name}?`)) {
                games = games.filter(g => g.id !== gameId);
                saveData();
                updateUI();
                showMessage(`${game.name} slettet`, '#FF9A42');
            }
        }

        function updateFinishButton() {
            if (games.length >= 3) {
                finishBtn.disabled = false;
                finishBtn.querySelector('.finish-hint').textContent = 'Klar til at afslutte!';
            } else {
                finishBtn.disabled = true;
                document.querySelector('.finish-hint').textContent = `Spil ${3 - games.length} flere spil for at afslutte`;
            }
        }

        function finishTournament() {
            if (games.length < 3) {
                alert('Spil mindst 3 spil før afslutning');
                return;
            }

            const standings = calculateStandings();
            const winner = standings[0];
            
            if (confirm(`Afslut turneringen?\n\nVinder: ${winner.name} (${winner.score} point)`)) {
                alert(`🏆 Tillykke til ${winner.name}!\n\nFinal stilling:\n${standings.map((team, i) => `${i + 1}. ${team.name} - ${team.score} point`).join('\n')}`);
                
                // Could redirect to a results page or reset
                if (confirm('Vil du starte en ny turnering?')) {
                    if (confirm('Dette vil slette alle data. Er du sikker?')) {
                        localStorage.clear();
                        window.location.href = 'index.html';
                    }
                }
            }
        }

        function updateSyncStatus() {
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (!status.initialized) {
                    statusIndicator.textContent = '🔄';
                    statusText.textContent = 'Connecting...';
                    syncStatus.style.background = 'rgba(255, 179, 102, 0.3)';
                } else if (!status.hasSupabase) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                } else if (!status.online) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else if (status.pendingSync > 0) {
                    statusIndicator.textContent = '⏳';
                    statusText.textContent = `Syncing ${status.pendingSync}...`;
                    syncStatus.style.background = 'rgba(69, 183, 209, 0.3)';
                } else if (status.hasSupabase && status.online) {
                    statusIndicator.textContent = '☁️';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = '📱';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) existingMessage.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideUp 0.3s ease forwards';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add animations
        if (!document.getElementById('games-animations')) {
            const animationStyle = document.createElement('style');
            animationStyle.id = 'games-animations';
            animationStyle.textContent = `
                @keyframes slideDown {
                    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    to { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
                
                @keyframes slideUp {
                    from { opacity: 1; transform: translateX(-50%) translateY(0); }
                    to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(animationStyle);
        }

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function() {
            if (games.length > 0) {
                saveData();
            }
        });
    </script>
</body>
</html>