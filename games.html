<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√•nd√¶g og H√•ndbajere - Spil</title>
    <link rel="stylesheet" href="games-styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">üèà H√•nd√¶g og H√•ndbajereüèà</h1>
            <p class="app-subtitle">Spil og Point</p>
        </header>

        <!-- Navigation -->
        <section class="navigation-section">
            <a href="simple-teams.html" class="nav-btn secondary">
                ‚Üê Tilbage til Hold
            </a>
            <a href="photos.html" class="nav-btn primary">
                N√¶ste: Fotos ‚Üí
            </a>
        </section>

        <!-- Game Selection View -->
        <div id="gameSelectionView" class="game-view">
            <!-- Standings -->
            <section class="standings-section">
                <h2 class="section-title">üèÜ Stillinger</h2>
                <div id="standingsGrid" class="standings-grid">
                    <!-- Standings will be populated here -->
                </div>
            </section>

            <!-- Add New Game -->
            <section class="add-game-section">
                <h2 class="section-title">‚ûï Tilf√∏j Nyt Spil</h2>
                <div class="add-game-card">
                    <div class="input-group">
                        <input type="text" id="gameNameInput" placeholder="Indtast spilnavn (f.eks. Andedammen, Dart, Golf)" maxlength="30">
                        <button id="addGameBtn" class="add-game-btn">
                            üéØ Tilf√∏j Spil
                        </button>
                    </div>
                    <p class="add-game-hint">Tilf√∏j et spil og tildel placeringer til holdene</p>
                </div>
            </section>

            <!-- Completed Games -->
            <section class="completed-section">
                <h3 class="section-title">
                    ‚úÖ Gennemf√∏rte Spil
                    <span class="completed-badge" id="completedCount">0</span>
                </h3>
                <div id="completedGames" class="completed-games">
                    <p class="no-games">Ingen spil gennemf√∏rt endnu</p>
                </div>
            </section>

            <!-- Finish Tournament -->
            <section class="finish-section">
                <button id="finishTournamentBtn" class="finish-btn" disabled>
                    üèÜ Afslut Konkurrence
                </button>
                <p class="finish-hint">Gennemf√∏r mindst 5 spil for at afslutte</p>
            </section>
        </div>

        <!-- Active Game View -->
        <div id="activeGameView" class="game-view" style="display: none;">
            <section class="active-game-section">
                <h2 class="game-title" id="currentGameName">Spil Navn</h2>
                
                <div class="winner-selection">
                    <h3>V√¶lg placeringer:</h3>
                    
                    <!-- 1st Place -->
                    <div class="winner-card" data-place="1">
                        <div class="place-header">
                            <span class="place-medal">ü•á</span>
                            <h4>1. Plads (2 point)</h4>
                        </div>
                        <div class="team-buttons">
                            <button class="team-btn" data-team="1">Hold 1</button>
                            <button class="team-btn" data-team="2">Hold 2</button>
                            <button class="team-btn" data-team="3">Hold 3</button>
                        </div>
                    </div>

                    <!-- 2nd Place -->
                    <div class="winner-card" data-place="2">
                        <div class="place-header">
                            <span class="place-medal">ü•à</span>
                            <h4>2. Plads (1 point)</h4>
                        </div>
                        <div class="team-buttons">
                            <button class="team-btn" data-team="1">Hold 1</button>
                            <button class="team-btn" data-team="2">Hold 2</button>
                            <button class="team-btn" data-team="3">Hold 3</button>
                        </div>
                    </div>

                    <!-- 3rd Place -->
                    <div class="winner-card" data-place="3">
                        <div class="place-header">
                            <span class="place-medal">ü•â</span>
                            <h4>3. Plads (0 point)</h4>
                        </div>
                        <div class="team-buttons">
                            <button class="team-btn" data-team="1">Hold 1</button>
                            <button class="team-btn" data-team="2">Hold 2</button>
                            <button class="team-btn" data-team="3">Hold 3</button>
                        </div>
                    </div>
                </div>

                <div class="game-actions">
                    <button id="cancelGameBtn" class="action-btn secondary">
                        ‚ùå Annuller
                    </button>
                    <button id="confirmResultBtn" class="action-btn primary" disabled>
                        ‚úÖ Bekr√¶ft Resultat
                    </button>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Custom game management system
        let teams = {};
        let players = [];
        let completedGamesList = [];
        let currentGame = null;
        let gameResults = {}; // { place: teamId }

        // DOM elements
        const gameSelectionView = document.getElementById('gameSelectionView');
        const activeGameView = document.getElementById('activeGameView');
        const standingsGrid = document.getElementById('standingsGrid');
        const currentGameName = document.getElementById('currentGameName');
        const confirmResultBtn = document.getElementById('confirmResultBtn');
        const cancelGameBtn = document.getElementById('cancelGameBtn');
        const completedGamesContainer = document.getElementById('completedGames');
        const completedCount = document.getElementById('completedCount');
        const finishTournamentBtn = document.getElementById('finishTournamentBtn');
        const gameNameInput = document.getElementById('gameNameInput');
        const addGameBtn = document.getElementById('addGameBtn');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Custom Games page loaded');
            loadRealData();
            renderStandings();
            setupEventListeners();
            updateCompletedGames();
            updateFinishButton();
        });

        function loadRealData() {
            console.log('üì• Loading real data for games...');
            
            // Load players
            try {
                const playersData = localStorage.getItem('bakken-players');
                if (playersData) {
                    players = JSON.parse(playersData);
                    console.log('‚úÖ Loaded players for games:', players);
                }
            } catch (e) {
                console.error('‚ùå Failed to load players:', e);
                players = [];
            }

            // Load teams
            try {
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const teamInfo = JSON.parse(teamsData);
                    const teamAssignments = teamInfo.teams || {};
                    const teamNames = teamInfo.teamNames || {};
                    
                    // Convert to format games expects
                    teams = {};
                    [1, 2, 3].forEach(teamId => {
                        const playerIds = teamAssignments[teamId] || [];
                        const teamMembers = playerIds.map(playerId => {
                            const player = players.find(p => p.id === playerId);
                            return player ? player.name : 'Unknown';
                        }).filter(name => name !== 'Unknown');
                        
                        teams[teamId] = {
                            name: teamNames[teamId] || `Hold ${teamId}`,
                            members: teamMembers,
                            score: 0
                        };
                    });
                    
                    console.log('‚úÖ Loaded teams for games:', teams);
                }
            } catch (e) {
                console.error('‚ùå Failed to load teams:', e);
                teams = {
                    1: { name: 'Hold 1', members: [], score: 0 },
                    2: { name: 'Hold 2', members: [], score: 0 },
                    3: { name: 'Hold 3', members: [], score: 0 }
                };
            }

            // Load completed games
            try {
                const gamesData = localStorage.getItem('bakken-games');
                if (gamesData) {
                    const gameInfo = JSON.parse(gamesData);
                    completedGamesList = gameInfo.completedGames || [];
                    
                    // Restore team scores
                    if (gameInfo.teamScores) {
                        Object.keys(gameInfo.teamScores).forEach(teamId => {
                            if (teams[teamId]) {
                                teams[teamId].score = gameInfo.teamScores[teamId];
                            }
                        });
                    }
                    
                    console.log('‚úÖ Loaded completed games:', completedGamesList);
                }
            } catch (e) {
                console.error('‚ùå Failed to load games:', e);
                completedGamesList = [];
            }

            // Update team button labels with real names
            updateTeamButtonLabels();
        }

        function updateTeamButtonLabels() {
            document.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = btn.dataset.team;
                if (teams[teamId]) {
                    btn.textContent = teams[teamId].name;
                }
            });
        }

        function saveGameData() {
            try {
                const teamScores = {};
                Object.keys(teams).forEach(teamId => {
                    teamScores[teamId] = teams[teamId].score;
                });
                
                const gameData = {
                    completedGames: completedGamesList,
                    teamScores: teamScores
                };
                
                localStorage.setItem('bakken-games', JSON.stringify(gameData));
                console.log('üíæ Saved game data:', gameData);
            } catch (e) {
                console.error('‚ùå Failed to save game data:', e);
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Add game functionality
            addGameBtn.addEventListener('click', addNewGame);
            gameNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewGame();
                }
            });
            
            gameNameInput.addEventListener('input', function() {
                addGameBtn.disabled = this.value.trim().length === 0;
            });

            // Team selection for places
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Team button clicked:', this.dataset.team, this.closest('.winner-card').dataset.place);
                    selectTeamForPlace(this.dataset.team, this.closest('.winner-card').dataset.place);
                });
            });

            // Game actions
            confirmResultBtn.addEventListener('click', confirmGameResult);
            cancelGameBtn.addEventListener('click', cancelGame);
            
            finishTournamentBtn.addEventListener('click', function() {
                if (completedGamesList.length >= 5) {
                    if (confirm('Er du sikker p√• at konkurrencen er f√¶rdig?')) {
                        showMessage('Konkurrencen er afsluttet! Tillykke til vinderne! üéâ');
                        finishTournamentBtn.textContent = 'üèÜ Konkurrence Afsluttet';
                        finishTournamentBtn.disabled = true;
                    }
                }
            });
        }

        function addNewGame() {
            const gameName = gameNameInput.value.trim();
            
            if (gameName === '') {
                showMessage('Indtast et spilnavn', '#FF5252');
                return;
            }
            
            // Check if game already exists
            const existingGame = completedGamesList.find(game => {
                const name = typeof game === 'string' ? game : game.name;
                return name.toLowerCase() === gameName.toLowerCase();
            });
            
            if (existingGame) {
                showMessage('Dette spil er allerede gennemf√∏rt', '#FF5252');
                return;
            }
            
            // Start the game
            startGame(gameName);
            gameNameInput.value = '';
            addGameBtn.disabled = true;
        }

        function startGame(gameName) {
            console.log('Starting custom game:', gameName);
            currentGame = gameName;
            gameResults = {};
            
            // Update UI
            currentGameName.textContent = gameName;
            gameSelectionView.style.display = 'none';
            activeGameView.style.display = 'block';
            
            // Reset team selections
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            document.querySelectorAll('.winner-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            updateConfirmButton();
        }

        function selectTeamForPlace(teamId, place) {
            console.log('Selecting team', teamId, 'for place', place);
            
            // Remove this team from other places
            Object.keys(gameResults).forEach(p => {
                if (gameResults[p] === teamId) {
                    delete gameResults[p];
                }
            });
            
            // Add team to this place
            gameResults[place] = teamId;
            
            // Update UI
            updateTeamButtonStates();
            updateConfirmButton();
        }

        function updateTeamButtonStates() {
            // Reset all buttons
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            
            document.querySelectorAll('.winner-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Update based on current selections
            Object.entries(gameResults).forEach(([place, teamId]) => {
                const card = document.querySelector(`[data-place="${place}"]`);
                const btn = card?.querySelector(`[data-team="${teamId}"]`);
                
                if (btn) {
                    btn.classList.add('selected');
                    card.classList.add('selected');
                }
                
                // Disable this team in other places
                document.querySelectorAll(`[data-team="${teamId}"]:not(.selected)`).forEach(otherBtn => {
                    otherBtn.disabled = true;
                    otherBtn.style.opacity = '0.5';
                });
            });
        }

        function updateConfirmButton() {
            const allPlacesSelected = Object.keys(gameResults).length === 3;
            confirmResultBtn.disabled = !allPlacesSelected;
        }

        function confirmGameResult() {
            if (Object.keys(gameResults).length !== 3) return;
            
            // Award points: 1st = 2 points, 2nd = 1 point, 3rd = 0 points
            const points = { 1: 2, 2: 1, 3: 0 };
            
            Object.entries(gameResults).forEach(([place, teamId]) => {
                teams[teamId].score += points[place];
            });
            
            // Record completed game
            completedGamesList.push({
                name: currentGame,
                results: { ...gameResults },
                timestamp: new Date().toISOString()
            });
            
            // Save data
            saveGameData();
            
            // Update UI
            renderStandings();
            updateCompletedGames();
            updateFinishButton();
            
            // Return to game selection
            activeGameView.style.display = 'none';
            gameSelectionView.style.display = 'block';
            currentGame = null;
            
            // Show success message
            const winner = teams[gameResults[1]];
            showMessage(`${winner.name} vandt ${currentGame}! üéâ`);
        }

        function cancelGame() {
            activeGameView.style.display = 'none';
            gameSelectionView.style.display = 'block';
            currentGame = null;
            gameResults = {};
        }

        function renderStandings() {
            // Sort teams by score
            const sortedTeams = Object.entries(teams)
                .sort(([,a], [,b]) => b.score - a.score)
                .map(([id, team], index) => ({
                    id,
                    ...team,
                    position: index + 1
                }));

            standingsGrid.innerHTML = sortedTeams.map(team => `
                <div class="team-standing ${getPositionClass(team.position)}">
                    <div class="standing-position">${team.position}</div>
                    <div class="standing-info">
                        <div class="standing-team">${team.name}</div>
                        <div class="standing-members">${team.members.join(', ')}</div>
                    </div>
                    <div class="standing-score">${team.score}</div>
                </div>
            `).join('');
        }

        function getPositionClass(position) {
            switch(position) {
                case 1: return 'first';
                case 2: return 'second';
                case 3: return 'third';
                default: return '';
            }
        }

        function updateCompletedGames() {
            completedCount.textContent = completedGamesList.length;
            
            if (completedGamesList.length === 0) {
                completedGamesContainer.innerHTML = '<p class="no-games">Ingen spil gennemf√∏rt endnu</p>';
                return;
            }
            
            completedGamesContainer.innerHTML = completedGamesList.map((game, index) => {
                const gameData = typeof game === 'string' ? { name: game } : game;
                const winner = gameData.results ? teams[gameData.results[1]] : null;
                return `
                    <div class="completed-game">
                        <div class="completed-game-info">
                            <div class="completed-game-name">${gameData.name}</div>
                            <div class="completed-game-result">${winner ? `Vinder: ${winner.name}` : 'Resultat gemt'}</div>
                        </div>
                        <button class="delete-game-btn" onclick="deleteGame(${index})" title="Slet spil">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        function deleteGame(gameIndex) {
            if (confirm('Er du sikker p√• at du vil slette dette spil? Point vil blive trukket fra.')) {
                const gameToDelete = completedGamesList[gameIndex];
                
                // Remove points from teams
                if (gameToDelete.results) {
                    const points = { 1: 2, 2: 1, 3: 0 };
                    Object.entries(gameToDelete.results).forEach(([place, teamId]) => {
                        if (teams[teamId]) {
                            teams[teamId].score -= points[place];
                            if (teams[teamId].score < 0) teams[teamId].score = 0;
                        }
                    });
                }
                
                // Remove from list
                completedGamesList.splice(gameIndex, 1);
                
                // Save and update
                saveGameData();
                renderStandings();
                updateCompletedGames();
                updateFinishButton();
                
                showMessage('Spil slettet og point justeret');
            }
        }

        function updateFinishButton() {
            const minGames = 5;
            finishTournamentBtn.disabled = completedGamesList.length < minGames;
            
            const finishHint = document.querySelector('.finish-hint');
            if (completedGamesList.length >= minGames) {
                finishHint.textContent = 'Klar til at afslutte konkurrencen!';
                finishHint.style.color = '#4ECDC4';
            } else {
                const remaining = minGames - completedGamesList.length;
                finishHint.textContent = `Gennemf√∏r ${remaining} spil mere for at afslutte`;
                finishHint.style.color = '#999';
            }
        }

        function showMessage(message, color = '#4ECDC4') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 3000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) messageDiv.remove();
            }, 3000);
        }

        // Add animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>