<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Håndæg og Håndbajere - Spiller</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">🎮 Håndæg og Håndbajere - SPILLER</h1>
            <p class="app-subtitle">Deltag i Turneringen Live</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">🔄</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Player Welcome Panel -->
        <section class="player-panel card">
            <h3 class="section-title">🎮 Spiller Dashboard</h3>
            <div class="tournament-overview grid grid-4">
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-value" id="tournamentStatus">Indlæser...</div>
                    <div class="stat-label">Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value" id="playerCountInfo">0</div>
                    <div class="stat-label">Spillere</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🏆</div>
                    <div class="stat-value" id="teamCountInfo">0</div>
                    <div class="stat-label">Hold</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🎮</div>
                    <div class="stat-value" id="gameCountInfo">0</div>
                    <div class="stat-label">Spil</div>
                </div>
            </div>
            
            <div class="player-actions">
                <button onclick="refreshData()" class="btn btn-secondary btn-sm">
                    🔄 Opdater Data
                </button>
                <button onclick="showPlayerHelp()" class="btn btn-outline btn-sm">
                    ❓ Hjælp
                </button>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <section class="tabs">
            <button class="tab-btn active" onclick="showTab('standings')">🏆 Stilling</button>
            <button class="tab-btn" onclick="showTab('addgame')">➕ Tilføj Spil</button>
            <button class="tab-btn" onclick="showTab('games')">🎮 Alle Spil</button>
            <button class="tab-btn" onclick="showTab('teams')">👥 Hold</button>
        </section>

        <!-- Standings Tab -->
        <div id="standingsTab" class="tab-content active">
            <!-- Current Standings -->
            <section class="card">
                <h2 class="section-title">🏆 Aktuel Stilling</h2>
                <div class="standings" id="standingsGrid">
                    <div class="empty-state">
                        <div class="empty-icon">🏆</div>
                        <h4>Indlæser stilling...</h4>
                        <p>Vent mens data hentes</p>
                    </div>
                </div>
            </section>

            <!-- Recent Games -->
            <section class="card">
                <h2 class="section-title">🎮 Seneste Spil</h2>
                <div class="recent-games" id="recentGames">
                    <div class="empty-state">
                        <div class="empty-icon">🎮</div>
                        <h4>Ingen seneste spil</h4>
                        <p>Spil vil vises her når de er afsluttet</p>
                    </div>
                </div>
            </section>

            <!-- Tournament Progress -->
            <section class="card">
                <h2 class="section-title">📈 Turnerings Fremgang</h2>
                <div class="progress-overview" id="progressOverview">
                    <div class="progress-item">
                        <div class="progress-label">Spillere tilføjet</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="playersProgress"></div>
                        </div>
                        <div class="progress-text" id="playersProgressText">0 spillere</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">Hold oprettet</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="teamsProgress"></div>
                        </div>
                        <div class="progress-text" id="teamsProgressText">0 hold</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">Spil afsluttet</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="gamesProgress"></div>
                        </div>
                        <div class="progress-text" id="gamesProgressText">0 spil</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Add Game Tab -->
        <div id="addgameTab" class="tab-content">
            <!-- Add New Game -->
            <section class="card">
                <h2 class="section-title">➕ Tilføj Nyt Spil</h2>
                
                <div class="add-game-form">
                    <div class="input-group">
                        <input type="text" 
                               id="gameNameInput" 
                               class="form-input"
                               placeholder="Indtast spil navn (f.eks. 'Fodbold', 'Løb', 'Quiz')" 
                               maxlength="50">
                        <button id="addGameBtn" class="btn btn-primary" disabled>
                            ➕ Tilføj & Indtast Resultat
                        </button>
                    </div>
                    <p class="help-text">Tilføj et nyt spil og indtast resultater med det samme</p>
                </div>
            </section>

            <!-- Quick Games -->
            <section class="card">
                <h2 class="section-title">⚡ Hurtige Spil</h2>
                <div class="quick-games-grid">
                    <button class="quick-game-btn" onclick="addQuickGame('Fodbold')">
                        <div class="quick-game-icon">⚽</div>
                        <div class="quick-game-name">Fodbold</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Løb')">
                        <div class="quick-game-icon">🏃</div>
                        <div class="quick-game-name">Løb</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Quiz')">
                        <div class="quick-game-icon">🧠</div>
                        <div class="quick-game-name">Quiz</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Kast')">
                        <div class="quick-game-icon">🎯</div>
                        <div class="quick-game-name">Kast</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Balance')">
                        <div class="quick-game-icon">⚖️</div>
                        <div class="quick-game-name">Balance</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Styrke')">
                        <div class="quick-game-icon">💪</div>
                        <div class="quick-game-name">Styrke</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Hurtighed')">
                        <div class="quick-game-icon">⚡</div>
                        <div class="quick-game-name">Hurtighed</div>
                    </button>
                    <button class="quick-game-btn" onclick="addQuickGame('Præcision')">
                        <div class="quick-game-icon">🎪</div>
                        <div class="quick-game-name">Præcision</div>
                    </button>
                </div>
            </section>

            <!-- Game Rules -->
            <section class="card">
                <h2 class="section-title">📋 Point System</h2>
                <div class="rules-grid">
                    <div class="rule-item">
                        <div class="rule-medal">🥇</div>
                        <div class="rule-text">
                            <strong>1. Plads</strong>
                            <span>2 point</span>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-medal">🥈</div>
                        <div class="rule-text">
                            <strong>2. Plads</strong>
                            <span>1 point</span>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-medal">🥉</div>
                        <div class="rule-text">
                            <strong>3. Plads</strong>
                            <span>0 point</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- All Games Tab -->
        <div id="gamesTab" class="tab-content">
            <section class="card">
                <h2 class="section-title">🎮 Alle Spil</h2>
                
                <!-- Game Filters -->
                <div class="game-filters">
                    <button class="filter-btn active" onclick="filterGames('all')">
                        Alle Spil
                    </button>
                    <button class="filter-btn" onclick="filterGames('completed')">
                        Afsluttede
                    </button>
                    <button class="filter-btn" onclick="filterGames('recent')">
                        Seneste 5
                    </button>
                </div>

                <!-- Games List -->
                <div class="games-list" id="allGamesList">
                    <div class="empty-state">
                        <div class="empty-icon">🎮</div>
                        <h4>Ingen spil endnu</h4>
                        <p>Spil vil vises her når de tilføjes</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Teams Tab -->
        <div id="teamsTab" class="tab-content">
            <section class="card">
                <h2 class="section-title">👥 Hold Oversigt</h2>
                <div class="teams-overview" id="teamsOverview">
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <h4>Ingen hold oprettet endnu</h4>
                        <p>Vent på host opretter hold</p>
                    </div>
                </div>
            </section>

            <!-- Team Statistics -->
            <section class="card" id="teamStatsSection" style="display: none;">
                <h2 class="section-title">📊 Hold Statistik</h2>
                <div class="team-stats" id="teamStats"></div>
            </section>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="resultsModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalGameTitle">🎯 Indtast Resultater</h2>
                <button class="modal-close" onclick="closeResultsModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="game-info">
                    <h3 id="modalGameName">Spil Navn</h3>
                    <div class="scoring-info">
                        🏆 <strong>Point System:</strong> 1. plads = 2 point, 2. plads = 1 point, 3. plads = 0 point
                    </div>
                </div>
                
                <div class="winner-selection">
                    <div class="winner-section">
                        <div class="place-header">
                            <span class="place-medal">🥇</span>
                            <h4>1. Plads (2 point)</h4>
                        </div>
                        <div class="team-buttons" id="firstPlaceButtons"></div>
                    </div>

                    <div class="winner-section">
                        <div class="place-header">
                            <span class="place-medal">🥈</span>
                            <h4>2. Plads (1 point)</h4>
                        </div>
                        <div class="team-buttons" id="secondPlaceButtons"></div>
                    </div>

                    <div class="winner-section" id="thirdPlaceSection">
                        <div class="place-header">
                            <span class="place-medal">🥉</span>
                            <h4>3. Plads (0 point)</h4>
                        </div>
                        <div class="team-buttons" id="thirdPlaceButtons"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="saveResultBtn" class="btn btn-success" disabled>
                    💾 Gem Resultat
                </button>
                <button class="btn btn-outline" onclick="closeResultsModal()">
                    ❌ Annuller
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>❓ Spiller Hjælp</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="help-section">
                    <h3>🎮 Som Spiller kan du:</h3>
                    <ul class="help-list">
                        <li>✅ Se live stilling og følge turneringen</li>
                        <li>✅ Tilføje nye spil og indtaste resultater</li>
                        <li>✅ Bruge hurtige spil shortcuts</li>
                        <li>✅ Se alle afsluttede spil og resultater</li>
                        <li>✅ Følge hold oversigt og spillere</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>📋 Point System:</h3>
                    <div class="help-points">
                        <div class="help-point">🥇 1. plads = <strong>2 point</strong></div>
                        <div class="help-point">🥈 2. plads = <strong>1 point</strong></div>
                        <div class="help-point">🥉 3. plads = <strong>0 point</strong></div>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>🔄 Opdateringer:</h3>
                    <p>Data opdateres automatisk hver 30. sekund. Brug "Opdater Data" knappen for manuel opdatering.</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeHelpModal()">
                    👍 Forstået
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Opdaterer...</h3>
            <p id="loadingText">Henter seneste data</p>
        </div>
    </div>

    <!-- Auto-refresh indicator -->
    <div id="refreshIndicator" class="refresh-indicator hidden">
        <div class="refresh-content">
            <div class="refresh-spinner"></div>
            <span>Opdaterer...</span>
        </div>
    </div>

    <script>
        // Player interface - Enhanced with new style system
        let players = [];
        let teams = [];
        let games = [];
        let currentGame = null;
        let selectedResults = { first: null, second: null, third: null };
        let currentFilter = 'all';
        let autoRefreshInterval = null;
        let lastUpdateTime = 0;

        // DOM elements
        const gameNameInput = document.getElementById('gameNameInput');
        const addGameBtn = document.getElementById('addGameBtn');
        const standingsGrid = document.getElementById('standingsGrid');
        const recentGames = document.getElementById('recentGames');
        const allGamesList = document.getElementById('allGamesList');
        const teamsOverview = document.getElementById('teamsOverview');
        const teamStatsSection = document.getElementById('teamStatsSection');
        const teamStats = document.getElementById('teamStats');
        
        const resultsModal = document.getElementById('resultsModal');
        const helpModal = document.getElementById('helpModal');
        const modalGameName = document.getElementById('modalGameName');
        const firstPlaceButtons = document.getElementById('firstPlaceButtons');
        const secondPlaceButtons = document.getElementById('secondPlaceButtons');
        const thirdPlaceButtons = document.getElementById('thirdPlaceButtons');
        const thirdPlaceSection = document.getElementById('thirdPlaceSection');
        const saveResultBtn = document.getElementById('saveResultBtn');
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const refreshIndicator = document.getElementById('refreshIndicator');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎮 Player interface starting...');
            showLoading('Starter spiller interface...');
            
            // Force player role
            localStorage.setItem('bakken-user-role', 'player');
            
            setTimeout(() => {
                loadAllData();
                setupEventListeners();
                updateAllUI();
                updateSyncStatus();
                startAutoRefresh();
                hideLoading();
                
                // Show welcome message
                setTimeout(() => {
                    showMessage('🎮 Velkommen til turneringen! Du kan nu tilføje spil og følge stillingen.', 'success');
                }, 1000);
            }, 1500);
        });

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showRefreshIndicator() {
            refreshIndicator.classList.remove('hidden');
            setTimeout(() => {
                refreshIndicator.classList.add('hidden');
            }, 2000);
        }

        function loadAllData() {
            try {
                // Load players
                const playersData = localStorage.getItem('bakken-players');
                players = playersData ? JSON.parse(playersData) : [];

                // Load teams
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const parsed = JSON.parse(teamsData);
                    teams = parsed.teams || [];
                }

                // Load games
                const gamesData = localStorage.getItem('bakken-games');
                if (gamesData) {
                    const parsed = JSON.parse(gamesData);
                    games = parsed.games || [];
                }

                lastUpdateTime = Date.now();
                console.log('📥 Player loaded data:', {
                    players: players.length,
                    teams: teams.length,
                    games: games.length
                });
            } catch (e) {
                console.error('❌ Load failed:', e);
                showMessage('⚠️ Fejl ved indlæsning af data', 'error');
            }
        }

        function setupEventListeners() {
            // Add game
            addGameBtn.addEventListener('click', addGameAndOpenPopup);
            gameNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addGameAndOpenPopup();
            });
            gameNameInput.addEventListener('input', function() {
                addGameBtn.disabled = this.value.trim().length === 0;
            });

            // Results modal
            saveResultBtn.addEventListener('click', saveGameResult);
            resultsModal.addEventListener('click', function(e) {
                if (e.target === resultsModal || e.target.classList.contains('modal-backdrop')) {
                    closeResultsModal();
                }
            });

            // Help modal
            helpModal.addEventListener('click', function(e) {
                if (e.target === helpModal || e.target.classList.contains('modal-backdrop')) {
                    closeHelpModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeResultsModal();
                    closeHelpModal();
                }
                if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    e.preventDefault();
                    refreshData();
                }
            });

            // Sync events
            setInterval(updateSyncStatus, 3000);
            
            // Listen for data updates
            window.addEventListener('bakken-data-updated', function(event) {
                console.log('🔄 Data updated:', event.detail);
                refreshData();
            });

            // Page visibility change
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Page became visible, refresh data
                    refreshData();
                }
            });
        }

        function startAutoRefresh() {
            // Auto-refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                if (!document.hidden) {
                    refreshData(true); // Silent refresh
                }
            }, 30000);
        }

        // Tab Management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Update UI for current tab
            updateAllUI();
        }

        // Data Refresh
        async function refreshData(silent = false) {
            if (!silent) {
                showRefreshIndicator();
                console.log('🔄 Refreshing player data...');
            }
            
            try {
                if (window.syncManager && window.syncManager.loadFromCloud) {
                    const cloudData = await window.syncManager.loadFromCloud();
                    
                    if (cloudData) {
                        let updated = false;
                        
                        // Update players
                        if (cloudData.players && cloudData.players.length > 0) {
                            const newPlayers = cloudData.players.map(p => ({ id: p.id, name: p.name }));
                            if (JSON.stringify(newPlayers) !== JSON.stringify(players)) {
                                players = newPlayers;
                                localStorage.setItem('bakken-players', JSON.stringify(players));
                                updated = true;
                            }
                        }
                        
                        // Update teams
                        if (cloudData.teams && cloudData.teams.teams_data) {
                            const newTeams = cloudData.teams.teams_data;
                            if (JSON.stringify(newTeams) !== JSON.stringify(teams)) {
                                teams = newTeams;
                                const teamsData = {
                                    teams: teams,
                                    teamNames: cloudData.teams.team_names || []
                                };
                                localStorage.setItem('bakken-teams', JSON.stringify(teamsData));
                                updated = true;
                            }
                        }
                        
                        // Update games
                        if (cloudData.games && cloudData.games.games_data) {
                            const newGames = cloudData.games.games_data;
                            if (JSON.stringify(newGames) !== JSON.stringify(games)) {
                                games = newGames;
                                const gamesData = { games: games };
                                localStorage.setItem('bakken-games', JSON.stringify(gamesData));
                                updated = true;
                            }
                        }
                        
                        if (updated) {
                            updateAllUI();
                            lastUpdateTime = Date.now();
                            if (!silent) {
                                showMessage('🔄 Data opdateret fra cloud', 'success');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Refresh failed:', error);
                if (!silent) {
                    showMessage('⚠️ Kunne ikke opdatere data', 'warning');
                }
            }
        }

        // Game Management
        function addGameAndOpenPopup() {
            const gameName = gameNameInput.value.trim();
            
            if (gameName === '') {
                showMessage('⚠️ Indtast et spil navn', 'warning');
                return;
            }
            
            if (teams.length < 2) {
                showMessage('⚠️ Minimum 2 hold krævet. Vent på host opretter hold.', 'warning');
                return;
            }
            
            if (games.some(game => game.name.toLowerCase() === gameName.toLowerCase())) {
                showMessage('⚠️ Dette spil findes allerede', 'warning');
                return;
            }
            
            const newGame = {
                id: generateId(),
                name: gameName,
                status: 'active',
                results: null,
                createdAt: Date.now(),
                addedBy: 'player'
            };
            
            games.push(newGame);
            currentGame = newGame;
            
            gameNameInput.value = '';
            addGameBtn.disabled = true;
            
            openResultsPopup();
            showMessage(`✅ "${gameName}" tilføjet - indtast resultater`, 'success');
        }

        function addQuickGame(gameName) {
            if (teams.length < 2) {
                showMessage('⚠️ Minimum 2 hold krævet. Vent på host opretter hold.', 'warning');
                return;
            }
            
            if (games.some(game => game.name.toLowerCase() === gameName.toLowerCase())) {
                showMessage('⚠️ Dette spil findes allerede', 'warning');
                return;
            }
            
            const newGame = {
                id: generateId(),
                name: gameName,
                status: 'active',
                results: null,
                createdAt: Date.now(),
                addedBy: 'player'
            };
            
            games.push(newGame);
            currentGame = newGame;
            
            openResultsPopup();
            showMessage(`⚡ "${gameName}" tilføjet - indtast resultater`, 'success');
        }

        function openResultsPopup() {
            if (!currentGame) return;
            
            selectedResults = { first: null, second: null, third: null };
            modalGameName.textContent = currentGame.name;
            
            generateTeamButtons();
            
            if (teams.length === 2) {
                thirdPlaceSection.style.display = 'none';
            } else {
                thirdPlaceSection.style.display = 'block';
            }
            
            resultsModal.classList.add('active');
            saveResultBtn.disabled = true;
        }

        function closeResultsModal() {
            resultsModal.classList.remove('active');
            
            if (currentGame && currentGame.status === 'active' && !currentGame.results) {
                games = games.filter(g => g.id !== currentGame.id);
            }
            
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            saveResultBtn.disabled = true;
            
            updateAllUI();
        }

        function generateTeamButtons() {
            const buttonHTML = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'first')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            firstPlaceButtons.innerHTML = buttonHTML;
            
            const buttonHTML2 = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'second')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            secondPlaceButtons.innerHTML = buttonHTML2;
            
            if (teams.length > 2) {
                const buttonHTML3 = teams.map(team => `
                    <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'third')">
                        ${escapeHtml(team.name)} (${team.players.length} spillere)
                    </button>
                `).join('');
                thirdPlaceButtons.innerHTML = buttonHTML3;
            }
        }

        function selectTeamForPlace(teamId, place) {
            selectedResults[place] = teamId;
            updateTeamButtonStates();
            
            const canSave = teams.length === 2 ? 
                (selectedResults.first !== null && selectedResults.second !== null) :
                (selectedResults.first !== null && selectedResults.second !== null && selectedResults.third !== null);
            
            saveResultBtn.disabled = !canSave;
        }

        function updateTeamButtonStates() {
            firstPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = btn.dataset.teamId;
                btn.classList.toggle('selected', selectedResults.first === teamId);
                btn.disabled = (selectedResults.second === teamId || selectedResults.third === teamId);
            });
            
            secondPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = btn.dataset.teamId;
                btn.classList.toggle('selected', selectedResults.second === teamId);
                btn.disabled = (selectedResults.first === teamId || selectedResults.third === teamId);
            });
            
            if (teams.length > 2) {
                thirdPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                    const teamId = btn.dataset.teamId;
                    btn.classList.toggle('selected', selectedResults.third === teamId);
                    btn.disabled = (selectedResults.first === teamId || selectedResults.second === teamId);
                });
            }
        }

        function saveGameResult() {
            if (!currentGame) return;
            
            if (teams.length === 2) {
                if (!selectedResults.first || !selectedResults.second) {
                    showMessage('⚠️ Vælg både 1. og 2. plads', 'warning');
                    return;
                }
                selectedResults.third = null;
            } else {
                if (!selectedResults.first || !selectedResults.second || !selectedResults.third) {
                    showMessage('⚠️ Vælg alle tre placeringer', 'warning');
                    return;
                }
            }
            
            const results = [];
            
            const firstTeam = teams.find(t => t.id === selectedResults.first);
            results.push({
                teamId: selectedResults.first,
                teamName: firstTeam.name,
                placement: 1,
                points: 2
            });
            
            const secondTeam = teams.find(t => t.id === selectedResults.second);
            results.push({
                teamId: selectedResults.second,
                teamName: secondTeam.name,
                placement: 2,
                points: 1
            });
            
            if (teams.length > 2 && selectedResults.third) {
                const thirdTeam = teams.find(t => t.id === selectedResults.third);
                results.push({
                    teamId: selectedResults.third,
                    teamName: thirdTeam.name,
                    placement: 3,
                    points: 0
                });
            }
            
            const placedTeamIds = [selectedResults.first, selectedResults.second, selectedResults.third].filter(id => id !== null);
            teams.forEach(team => {
                if (!placedTeamIds.includes(team.id)) {
                    results.push({
                        teamId: team.id,
                        teamName: team.name,
                        placement: teams.length > 2 ? 4 : 3,
                        points: 0
                    });
                }
            });
            
            currentGame.results = results;
            currentGame.status = 'completed';
            currentGame.completedAt = Date.now();
            
            saveData('games');
            
            resultsModal.classList.remove('active');
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            
            updateAllUI();
            showMessage(`✅ Resultat gemt for "${currentGame ? currentGame.name : 'spillet'}"!`, 'success');
            
            gameNameInput.focus();
        }

        // Filter Functions
        function filterGames(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateAllGamesUI();
        }

        // Help Functions
        function showPlayerHelp() {
            helpModal.classList.add('active');
        }

        function closeHelpModal() {
            helpModal.classList.remove('active');
        }

        // Data Management
        function saveData(type) {
            try {
                switch (type) {
                    case 'games':
                        const gamesData = { games: games };
                        localStorage.setItem('bakken-games', JSON.stringify(gamesData));
                        if (window.syncManager && window.syncManager.syncGames) {
                            window.syncManager.syncGames(gamesData);
                        }
                        break;
                }
            } catch (e) {
                console.error('Save failed:', e);
                showMessage('⚠️ Fejl ved gemning', 'error');
            }
        }

        // UI Updates
        function updateAllUI() {
            updateTournamentInfo();
            updateStandingsUI();
            updateRecentGamesUI();
            updateAllGamesUI();
            updateTeamsOverviewUI();
            updateProgressOverview();
        }

        function updateTournamentInfo() {
            document.getElementById('playerCountInfo').textContent = players.length;
            document.getElementById('teamCountInfo').textContent = teams.length;
            document.getElementById('gameCountInfo').textContent = games.filter(g => g.status === 'completed').length;
            
            const status = teams.length >= 2 ? '✅ Aktiv' : '⚠️ Venter på hold';
            document.getElementById('tournamentStatus').innerHTML = status;
        }

        function updateProgressOverview() {
            // Players progress (assume max 20 players)
            const playersPercent = Math.min((players.length / 20) * 100, 100);
            document.getElementById('playersProgress').style.width = playersPercent + '%';
            document.getElementById('playersProgressText').textContent = `${players.length} spillere`;
            
            // Teams progress (assume max 6 teams)
            const teamsPercent = Math.min((teams.length / 6) * 100, 100);
            document.getElementById('teamsProgress').style.width = teamsPercent + '%';
            document.getElementById('teamsProgressText').textContent = `${teams.length} hold`;
            
            // Games progress (assume max 15 games)
            const completedGames = games.filter(g => g.status === 'completed').length;
            const gamesPercent = Math.min((completedGames / 15) * 100, 100);
            document.getElementById('gamesProgress').style.width = gamesPercent + '%';
            document.getElementById('gamesProgressText').textContent = `${completedGames} spil`;
        }

        function updateStandingsUI() {
            if (teams.length === 0) {
                standingsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <h4>Venter på hold</h4>
                        <p>Host skal oprette hold først</p>
                    </div>
                `;
                return;
            }
            
            const standings = teams.map(team => {
                let totalPoints = 0;
                let gamesPlayed = 0;
                
                games.forEach(game => {
                    if (game.status === 'completed' && game.results) {
                        const teamResult = game.results.find(r => r.teamId === team.id);
                        if (teamResult) {
                            totalPoints += teamResult.points;
                            gamesPlayed++;
                        }
                    }
                });
                
                return { ...team, totalPoints, gamesPlayed };
            });
            
            standings.sort((a, b) => b.totalPoints - a.totalPoints);
            
            standingsGrid.innerHTML = standings.map((team, index) => `
                <div class="standing-item ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                    <div class="standing-position">${index + 1}</div>
                    <div class="standing-info">
                        <div class="standing-team">${escapeHtml(team.name)}</div>
                        <div class="standing-details">
                            ${team.players.map(p => p.name).join(', ')} • ${team.gamesPlayed} spil
                        </div>
                    </div>
                    <div class="standing-score">${team.totalPoints}</div>
                </div>
            `).join('');
        }

        function updateRecentGamesUI() {
            const completedGames = games.filter(g => g.status === 'completed');
            const recentGamesList = completedGames.slice(-3).reverse();
            
            if (recentGamesList.length === 0) {
                recentGames.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🎮</div>
                        <h4>Ingen seneste spil</h4>
                        <p>Spil vil vises her når de er afsluttet</p>
                    </div>
                `;
                return;
            }
            
            recentGames.innerHTML = recentGamesList.map(game => `
                <div class="game-item recent">
                    <div class="game-header">
                        <div class="game-name">${escapeHtml(game.name)}</div>
                        <div class="game-time">${getTimeAgo(game.completedAt)}</div>
                    </div>
                    <div class="game-result">
                        🥇 ${game.results[0].teamName} | 
                        🥈 ${game.results[1].teamName}
                        ${game.results.length > 2 && game.results[2] ? ` | 🥉 ${game.results[2].teamName}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateAllGamesUI() {
            let filteredGames = games;
            
            switch (currentFilter) {
                case 'completed':
                    filteredGames = games.filter(g => g.status === 'completed');
                    break;
                case 'recent':
                    filteredGames = games.filter(g => g.status === 'completed').slice(-5).reverse();
                    break;
                default:
                    filteredGames = games;
            }
            
            if (filteredGames.length === 0) {
                allGamesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🎮</div>
                        <h4>Ingen spil i denne kategori</h4>
                        <p>Spil vil vises her når de tilføjes</p>
                    </div>
                `;
                return;
            }
            
            allGamesList.innerHTML = filteredGames.map(game => `
                <div class="game-item ${game.status}">
                    <div class="game-header">
                        <div class="game-name">${escapeHtml(game.name)}</div>
                        <div class="game-status ${game.status}">
                            ${game.status === 'completed' ? '✅ Afsluttet' : '⏳ Aktiv'}
                        </div>
                    </div>
                    ${game.status === 'completed' && game.results ? `
                        <div class="game-result">
                            🥇 ${game.results[0].teamName} (2 pt) | 
                            🥈 ${game.results[1].teamName} (1 pt)
                            ${game.results.length > 2 && game.results[2] ? ` | 🥉 ${game.results[2].teamName} (0 pt)` : ''}
                        </div>
                        <div class="game-meta">
                            Afsluttet ${getTimeAgo(game.completedAt)}
                            ${game.addedBy ? ` • Tilføjet af ${game.addedBy}` : ''}
                        </div>
                    ` : `
                        <div class="game-pending">Venter på resultater</div>
                        <div class="game-meta">
                            Oprettet ${getTimeAgo(game.createdAt)}
                            ${game.addedBy ? ` • Tilføjet af ${game.addedBy}` : ''}
                        </div>
                    `}
                </div>
            `).join('');
        }

        function updateTeamsOverviewUI() {
            if (teams.length === 0) {
                teamsOverview.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <h4>Ingen hold oprettet endnu</h4>
                        <p>Vent på host opretter hold</p>
                    </div>
                `;
                teamStatsSection.style.display = 'none';
                return;
            }
            
            teamsOverview.innerHTML = teams.map((team, index) => `
                <div class="team-card">
                    <div class="team-header">
                        <div class="team-info">
                            <div class="team-color-indicator team-${(index % 12) + 1}-color"></div>
                            <span class="team-name">${escapeHtml(team.name)}</span>
                        </div>
                        <span class="team-count">${(team.players || []).length} spillere</span>
                    </div>
                    <div class="team-players">
                        ${(team.players || []).map(player => `
                            <div class="chip">${escapeHtml(player.name)}</div>
                        `).join('')}
                        ${(team.players || []).length === 0 ? '<div class="empty-team">Ingen spillere</div>' : ''}
                    </div>
                    <div class="team-stats-mini">
                        ${getTeamStats(team.id)}
                    </div>
                </div>
            `).join('');
            
            // Show team statistics
            updateTeamStatistics();
            teamStatsSection.style.display = 'block';
        }

        function getTeamStats(teamId) {
            let wins = 0;
            let totalGames = 0;
            let totalPoints = 0;
            
            games.forEach(game => {
                if (game.status === 'completed' && game.results) {
                    const teamResult = game.results.find(r => r.teamId === teamId);
                    if (teamResult) {
                        totalGames++;
                        totalPoints += teamResult.points;
                        if (teamResult.placement === 1) wins++;
                    }
                }
            });
            
            return `
                <div class="mini-stat">🏆 ${wins} sejre</div>
                <div class="mini-stat">🎮 ${totalGames} spil</div>
                <div class="mini-stat">⭐ ${totalPoints} point</div>
            `;
        }

        function updateTeamStatistics() {
            const stats = teams.map(team => {
                let wins = 0;
                let seconds = 0;
                let thirds = 0;
                let totalGames = 0;
                let totalPoints = 0;
                
                games.forEach(game => {
                    if (game.status === 'completed' && game.results) {
                        const teamResult = game.results.find(r => r.teamId === team.id);
                        if (teamResult) {
                            totalGames++;
                            totalPoints += teamResult.points;
                            if (teamResult.placement === 1) wins++;
                            else if (teamResult.placement === 2) seconds++;
                            else if (teamResult.placement === 3) thirds++;
                        }
                    }
                });
                
                return {
                    ...team,
                    wins,
                    seconds,
                    thirds,
                    totalGames,
                    totalPoints,
                    winRate: totalGames > 0 ? (wins / totalGames * 100).toFixed(1) : 0
                };
            });
            
            teamStats.innerHTML = `
                <div class="stats-grid">
                    ${stats.map(team => `
                        <div class="stat-card team-stat">
                            <h4>${escapeHtml(team.name)}</h4>
                            <div class="stat-details">
                                <div class="stat-row">
                                    <span>🥇 Sejre:</span>
                                    <strong>${team.wins}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>🥈 Andenpladser:</span>
                                    <strong>${team.seconds}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>🥉 Tredjepladser:</span>
                                    <strong>${team.thirds}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>📊 Sejrsrate:</span>
                                    <strong>${team.winRate}%</strong>
                                </div>
                                <div class="stat-row total">
                                    <span>⭐ Total point:</span>
                                    <strong>${team.totalPoints}</strong>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateSyncStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const syncStatus = document.getElementById('syncStatus');
            
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (status.initialized && status.hasSupabase && status.online) {
                    statusIndicator.textContent = '☁️';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else if (status.initialized && !status.online) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = '📱';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        // Utility Functions
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `${days} dag${days > 1 ? 'e' : ''} siden`;
            if (hours > 0) return `${hours} time${hours > 1 ? 'r' : ''} siden`;
            if (minutes > 0) return `${minutes} minut${minutes > 1 ? 'ter' : ''} siden`;
            return 'Lige nu';
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            
            const colors = {
                success: '#4ECDC4',
                warning: '#FFB366',
                error: '#FF6B6B',
                info: '#45B7D1'
            };
            
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 2000;
                font-weight: 500;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 4000);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>

    <style>
        /* Player-specific styles */
        .player-panel {
            background: linear-gradient(135deg, rgba(69, 183, 209, 0.1), rgba(78, 205, 196, 0.05));
            border-left: 4px solid #45B7D1;
        }

        .tournament-overview {
            margin: 20px 0;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(69, 183, 209, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #45B7D1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .player-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .progress-overview {
            margin: 20px 0;
        }

        .progress-item {
            margin: 15px 0;
        }

        .progress-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #45B7D1, #4ECDC4);
            border-radius: 4px;
            transition: width 0.8s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
        }

        .add-game-form {
            margin: 20px 0;
        }

        .quick-games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .quick-game-btn {
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 15px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-game-btn:hover {
            background: #4ECDC4;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .quick-game-icon {
            font-size: 2rem;
        }

        .quick-game-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .rule-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 3px solid #4ECDC4;
        }

        .rule-medal {
            font-size: 1.5rem;
        }

        .rule-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .rule-text strong {
            color: #333;
        }

        .rule-text span {
            color: #666;
            font-size: 0.9rem;
        }

        .game-filters {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #45B7D1;
            color: #45B7D1;
        }

        .filter-btn.active {
            border-color: #45B7D1;
            background: #45B7D1;
            color: white;
        }

        .games-list {
            margin: 20px 0;
        }

        .game-item.recent {
            border-left-color: #4ECDC4;
        }

        .game-item.completed {
            border-left-color: #96CEB4;
        }

        .game-item.active {
            border-left-color: #FFB366;
        }

        .game-time {
            font-size: 0.8rem;
            color: #999;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 10px;
        }

        .game-pending {
            color: #FFB366;
            font-style: italic;
            margin: 8px 0;
        }

        .team-stats-mini {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .mini-stat {
            font-size: 0.8rem;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .team-stat {
            text-align: left;
        }

        .team-stat h4 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #4ECDC4;
            padding-bottom: 8px;
        }

        .stat-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .stat-row.total {
            border-top: 1px solid #eee;
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 600;
        }

        .empty-team {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        .help-section {
            margin: 20px 0;
        }

        .help-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .help-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .help-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .help-list li:last-child {
            border-bottom: none;
        }

        .help-points {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .help-point {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .refresh-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(69, 183, 209, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            z-index: 1500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .refresh-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .team-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Team colors */
        .team-1-color { background: #FF6B6B; }
        .team-2-color { background: #4ECDC4; }
        .team-3-color { background: #45B7D1; }
        .team-4-color { background: #96CEB4; }
        .team-5-color { background: #FFEAA7; }
        .team-6-color { background: #DDA0DD; }
        .team-7-color { background: #98D8C8; }
        .team-8-color { background: #F7DC6F; }
        .team-9-color { background: #BB8FCE; }
        .team-10-color { background: #85C1E9; }
        .team-11-color { background: #F8C471; }
        .team-12-color { background: #82E0AA; }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .tournament-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .player-actions {
                flex-direction: column;
                align-items: center;
            }

            .quick-games-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .rules-grid {
                grid-template-columns: 1fr;
            }

            .game-filters {
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .team-stats-mini {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .tournament-overview {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .quick-games-grid {
                grid-template-columns: 1fr;
            }

            .quick-game-btn {
                padding: 15px;
            }
        }
    </style>
</body>
</html>