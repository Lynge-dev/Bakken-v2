<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√•nd√¶g og H√•ndbajere - Host</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">üëë H√•nd√¶g og H√•ndbajere - HOST</h1>
            <p class="app-subtitle">Komplet Turnerings Kontrol</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Host Info Panel -->
        <section class="host-info-section">
            <div class="host-info-card">
                <h3>üëë Host Kontrol Panel</h3>
                <div class="host-actions">
                    <button onclick="generatePlayerLink()" class="host-btn primary">
                        üì± Generer Spiller Link
                    </button>
                    <button onclick="showTournamentInfo()" class="host-btn secondary">
                        ‚ÑπÔ∏è Turnerings Info
                    </button>
                    <button onclick="resetTournament()" class="host-btn danger">
                        üîÑ Nulstil Turnering
                    </button>
                </div>
                <div id="playerLinkContainer" style="margin-top: 15px; display: none;">
                    <h4>üì± Spiller Link:</h4>
                    <div class="link-container">
                        <input type="text" id="playerLinkInput" readonly style="width: 100%; padding: 10px; border: 2px solid #4ECDC4; border-radius: 8px; font-family: monospace;">
                        <button onclick="copyPlayerLink()" style="margin-top: 10px; background: #4ECDC4; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            üìã Kopier Link
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <section class="tabs-section">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('players')">üë• Spillere</button>
                <button class="tab-btn" onclick="showTab('teams')">üèÜ Hold</button>
                <button class="tab-btn" onclick="showTab('games')">üéÆ Spil</button>
                <button class="tab-btn" onclick="showTab('photos')">üì∏ Billeder</button>
            </div>
        </section>

        <!-- Players Tab -->
        <div id="playersTab" class="tab-content active">
            <section class="input-section">
                <h2 class="section-title">üë• Tilf√∏j Spillere</h2>
                <div class="input-group">
                    <input type="text" 
                           id="playerInput" 
                           placeholder="Indtast spillernavn" 
                           maxlength="30"
                           autocomplete="off">
                    <button id="addPlayerBtn" class="add-btn" disabled>
                        Tilf√∏j Spiller
                    </button>
                </div>
            </section>

            <section class="players-section">
                <h2 class="section-title">
                    Spillere 
                    <span class="player-count" id="playerCount">0</span>
                </h2>
                <div class="players-list" id="playersList">
                    <div class="empty-message">Ingen spillere tilf√∏jet endnu</div>
                </div>
                <button id="clearAllPlayersBtn" class="action-btn secondary" style="display: none;">
                    üóëÔ∏è Ryd Alle Spillere
                </button>
            </section>
        </div>

        <!-- Teams Tab -->
        <div id="teamsTab" class="tab-content">
            <section class="team-controls-section">
                <h2 class="section-title">‚öôÔ∏è Hold Indstillinger</h2>
                <div class="team-count-controls">
                    <label for="teamCountInput">Antal Hold:</label>
                    <div class="count-input-group">
                        <button id="decreaseTeamsBtn" class="count-btn">-</button>
                        <input type="number" id="teamCountInput" min="2" max="20" value="3" readonly>
                        <button id="increaseTeamsBtn" class="count-btn">+</button>
                    </div>
                </div>
            </section>

            <section class="team-names-section">
                <h2 class="section-title">üìù Hold Navne</h2>
                <div class="team-names-grid" id="teamNamesGrid">
                    <p>Tilf√∏j spillere f√∏rst</p>
                </div>
            </section>

            <section class="controls-section">
                <div class="control-buttons">
                    <button id="shuffleBtn" class="control-btn primary">üîÄ Bland Hold</button>
                    <button id="resetTeamsBtn" class="control-btn secondary">üîÑ Nulstil Hold</button>
                    <button id="autoDistributeBtn" class="control-btn tertiary">‚ö° Auto-fordel</button>
                </div>
            </section>

            <section class="teams-section">
                <div class="teams-grid" id="teamsGrid">
                    <p>Opret hold f√∏rst</p>
                </div>
            </section>
        </div>

        <!-- Games Tab -->
        <div id="gamesTab" class="tab-content">
            <section class="standings-section">
                <h2 class="section-title">üèÜ Aktuel Stilling</h2>
                <div class="standings-grid" id="standingsGrid">
                    <div class="loading-standings">Opret hold f√∏rst</div>
                </div>
            </section>

            <section class="add-game-section">
                <h2 class="section-title">‚ûï Tilf√∏j Nyt Spil</h2>
                <div class="input-group">
                    <input type="text" 
                           id="gameNameInput" 
                           placeholder="Indtast spil navn (f.eks. 'Fodbold', 'L√∏b', 'Quiz')" 
                           maxlength="50">
                    <button id="addGameBtn" class="add-game-btn" disabled>
                        ‚ûï Tilf√∏j & Indtast Resultat
                    </button>
                </div>
            </section>

            <section class="completed-section">
                <h2 class="section-title">
                    ‚úÖ Afsluttede Spil 
                    <span class="completed-badge" id="completedCount">0</span>
                </h2>
                <div class="completed-games" id="completedGames">
                    <div class="no-completed">
                        <p>Ingen afsluttede spil endnu</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Photos Tab -->
        <div id="photosTab" class="tab-content">
            <section class="photos-section">
                <h2 class="section-title">üì∏ Turnerings Billeder</h2>
                <div class="photo-upload">
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                    <button onclick="document.getElementById('photoInput').click()" class="photo-btn primary">
                        üì∑ Tag Billede / Upload
                    </button>
                    <button onclick="takeGroupPhoto()" class="photo-btn secondary">
                        üë• Gruppe Billede
                    </button>
                </div>
                <div class="photos-grid" id="photosGrid">
                    <div class="no-photos">
                        <p>Ingen billeder uploadet endnu</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="resultsModal">
        <div class="modal-backdrop" onclick="closeResultsModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalGameTitle">üéØ Indtast Resultater</h2>
                <button class="close-btn" onclick="closeResultsModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="game-info">
                    <h3 id="modalGameName">Spil Navn</h3>
                    <p class="scoring-info">üèÜ Point System: 1. plads = 2 point, 2. plads = 1 point, 3. plads = 0 point</p>
                </div>
                
                <div class="winner-selection">
                    <div class="winner-card">
                        <div class="place-header">
                            <span class="place-medal">ü•á</span>
                            <h4>1. Plads (2 point)</h4>
                        </div>
                        <div class="team-buttons" id="firstPlaceButtons"></div>
                    </div>

                    <div class="winner-card">
                        <div class="place-header">
                            <span class="place-medal">ü•à</span>
                            <h4>2. Plads (1 point)</h4>
                        </div>
                        <div class="team-buttons" id="secondPlaceButtons"></div>
                    </div>

                    <div class="winner-card" id="thirdPlaceCard">
                        <div class="place-header">
                            <span class="place-medal">ü•â</span>
                            <h4>3. Plads (0 point)</h4>
                        </div>
                        <div class="team-buttons" id="thirdPlaceButtons"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="saveResultBtn" class="modal-btn primary" disabled>
                    üíæ Gem Resultat
                </button>
                <button id="cancelResultBtn" class="modal-btn secondary" onclick="closeResultsModal()">
                    ‚ùå Annuller
                </button>
            </div>
        </div>
    </div>

    <script>
        // Host interface - Complete tournament management
        let players = [];
        let teams = [];
        let teamNames = [];
        let games = [];
        let photos = [];
        let desiredTeamCount = 3;
        let currentGame = null;
        let selectedResults = { first: null, second: null, third: null };

        // DOM elements
        const playerInput = document.getElementById('playerInput');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const clearAllPlayersBtn = document.getElementById('clearAllPlayersBtn');
        
        const teamCountInput = document.getElementById('teamCountInput');
        const decreaseTeamsBtn = document.getElementById('decreaseTeamsBtn');
        const increaseTeamsBtn = document.getElementById('increaseTeamsBtn');
        const teamNamesGrid = document.getElementById('teamNamesGrid');
        const teamsGrid = document.getElementById('teamsGrid');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const resetTeamsBtn = document.getElementById('resetTeamsBtn');
        const autoDistributeBtn = document.getElementById('autoDistributeBtn');
        
        const gameNameInput = document.getElementById('gameNameInput');
        const addGameBtn = document.getElementById('addGameBtn');
        const standingsGrid = document.getElementById('standingsGrid');
        const completedGames = document.getElementById('completedGames');
        const completedCount = document.getElementById('completedCount');
        
        const resultsModal = document.getElementById('resultsModal');
        const modalGameName = document.getElementById('modalGameName');
        const firstPlaceButtons = document.getElementById('firstPlaceButtons');
        const secondPlaceButtons = document.getElementById('secondPlaceButtons');
        const thirdPlaceButtons = document.getElementById('thirdPlaceButtons');
        const thirdPlaceCard = document.getElementById('thirdPlaceCard');
        const saveResultBtn = document.getElementById('saveResultBtn');
        
        const photosGrid = document.getElementById('photosGrid');
        const photoInput = document.getElementById('photoInput');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üëë Host interface starting...');
            
            // Force host role
            localStorage.setItem('bakken-user-role', 'host');
            
            loadAllData();
            setupEventListeners();
            updateAllUI();
            updateSyncStatus();
        });

        function loadAllData() {
            // Load players
            try {
                const playersData = localStorage.getItem('bakken-players');
                players = playersData ? JSON.parse(playersData) : [];
            } catch (e) {
                players = [];
            }

            // Load teams
            try {
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const parsed = JSON.parse(teamsData);
                    teams = parsed.teams || [];
                    teamNames = parsed.teamNames || [];
                    desiredTeamCount = teams.length || 3;
                    teamCountInput.value = desiredTeamCount;
                }
            } catch (e) {
                teams = [];
                teamNames = [];
            }

            // Load games
            try {
                const gamesData = localStorage.getItem('bakken-games');
                if (gamesData) {
                    const parsed = JSON.parse(gamesData);
                    games = parsed.games || [];
                }
            } catch (e) {
                games = [];
            }

            // Load photos
            try {
                const photosData = localStorage.getItem('bakken-photos');
                photos = photosData ? JSON.parse(photosData) : [];
            } catch (e) {
                photos = [];
            }

            console.log('üì• Loaded data:', {
                players: players.length,
                teams: teams.length,
                games: games.length,
                photos: photos.length
            });
        }

        function setupEventListeners() {
            // Players
            addPlayerBtn.addEventListener('click', addPlayer);
            playerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPlayer();
            });
            playerInput.addEventListener('input', function() {
                addPlayerBtn.disabled = this.value.trim().length === 0;
            });
            clearAllPlayersBtn.addEventListener('click', clearAllPlayers);

            // Teams
            decreaseTeamsBtn.addEventListener('click', () => changeTeamCount(desiredTeamCount - 1));
            increaseTeamsBtn.addEventListener('click', () => changeTeamCount(desiredTeamCount + 1));
            shuffleBtn.addEventListener('click', shuffleTeams);
            resetTeamsBtn.addEventListener('click', resetTeams);
            autoDistributeBtn.addEventListener('click', autoDistributeTeams);

            // Games
            addGameBtn.addEventListener('click', addGameAndOpenPopup);
            gameNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addGameAndOpenPopup();
            });
            gameNameInput.addEventListener('input', function() {
                addGameBtn.disabled = this.value.trim().length === 0;
            });
            saveResultBtn.addEventListener('click', saveGameResult);

            // Photos
            photoInput.addEventListener('change', handlePhotoUpload);

            // Modal events
            resultsModal.addEventListener('click', function(e) {
                if (e.target === resultsModal || e.target.classList.contains('modal-backdrop')) {
                    closeResultsModal();
                }
            });

            // Sync events
            setInterval(updateSyncStatus, 3000);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Update UI for current tab
            updateAllUI();
        }

        // Host Functions
        function generatePlayerLink() {
            const baseUrl = window.location.origin + window.location.pathname.replace('host.html', '');
            const playerUrl = baseUrl + 'player.html';
            
            document.getElementById('playerLinkInput').value = playerUrl;
            document.getElementById('playerLinkContainer').style.display = 'block';
            
            showMessage('üì± Spiller link genereret!', '#4ECDC4');
        }

        function copyPlayerLink() {
            const linkInput = document.getElementById('playerLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showMessage('üìã Link kopieret!', '#4ECDC4');
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(linkInput.value).then(() => {
                        showMessage('üìã Link kopieret!', '#4ECDC4');
                    });
                }
            }
        }

        function showTournamentInfo() {
            const info = `üèÜ TURNERINGS INFO:
            
üë• Spillere: ${players.length}
üèÜ Hold: ${teams.length}
üéÆ Spil: ${games.filter(g => g.status === 'completed').length}
üì∏ Billeder: ${photos.length}

üîó Tournament ID: ${localStorage.getItem('bakken-tournament-id')}
üëë Rolle: Host`;
            
            alert(info);
        }

        function resetTournament() {
            if (confirm('‚ö†Ô∏è ADVARSEL: Dette vil slette ALT data!\n\nSpillere, hold, spil og billeder vil blive fjernet.\n\nEr du sikker?')) {
                localStorage.removeItem('bakken-players');
                localStorage.removeItem('bakken-teams');
                localStorage.removeItem('bakken-games');
                localStorage.removeItem('bakken-photos');
                
                players = [];
                teams = [];
                games = [];
                photos = [];
                
                updateAllUI();
                showMessage('üîÑ Turnering nulstillet', '#FF9A42');
            }
        }

        // Player Management
        function addPlayer() {
            const name = playerInput.value.trim();
            
            if (name === '') {
                showMessage('‚ö†Ô∏è Indtast et spillernavn', '#FF9A42');
                return;
            }
            
            if (players.some(player => player.name.toLowerCase() === name.toLowerCase())) {
                showMessage('‚ö†Ô∏è Spilleren findes allerede', '#FF9A42');
                return;
            }
            
            const newPlayer = {
                id: generateId(),
                name: name
            };
            
            players.push(newPlayer);
            playerInput.value = '';
            addPlayerBtn.disabled = true;
            
            saveData('players');
            updateAllUI();
            showMessage('‚úÖ ' + name + ' tilf√∏jet!', '#4ECDC4');
            
            playerInput.focus();
        }

        function removePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && confirm('Fjern ' + player.name + '?')) {
                players = players.filter(p => p.id !== playerId);
                
                // Remove from teams
                teams.forEach(team => {
                    if (team.players) {
                        team.players = team.players.filter(p => p.id !== playerId);
                    }
                });
                
                saveData('players');
                saveData('teams');
                updateAllUI();
                showMessage('üóëÔ∏è ' + player.name + ' fjernet', '#FF9A42');
            }
        }

        function clearAllPlayers() {
            if (players.length === 0) return;
            
            if (confirm('Fjern alle ' + players.length + ' spillere?')) {
                players = [];
                teams = [];
                games = [];
                
                saveData('players');
                saveData('teams');
                saveData('games');
                updateAllUI();
                showMessage('üóëÔ∏è Alle spillere fjernet', '#FF9A42');
            }
        }

        // Team Management
        function changeTeamCount(newCount) {
            if (newCount < 2) newCount = 2;
            if (newCount > 20) newCount = 20;
            
            const oldCount = teams.length;
            desiredTeamCount = newCount;
            teamCountInput.value = newCount;
            
            if (newCount > oldCount) {
                // Add new teams
                for (let i = oldCount; i < newCount; i++) {
                    const teamName = `Hold ${i + 1}`;
                    teams.push({
                        id: i + 1,
                        name: teamName,
                        players: []
                    });
                    teamNames.push(teamName);
                }
            } else if (newCount < oldCount) {
                // Remove teams and redistribute players
                const playersToRedistribute = [];
                
                for (let i = newCount; i < oldCount; i++) {
                    if (teams[i] && teams[i].players) {
                        playersToRedistribute.push(...teams[i].players);
                    }
                }
                
                teams = teams.slice(0, newCount);
                teamNames = teamNames.slice(0, newCount);
                
                if (playersToRedistribute.length > 0) {
                    playersToRedistribute.forEach((player, index) => {
                        const targetTeamIndex = index % newCount;
                        teams[targetTeamIndex].players.push(player);
                    });
                }
            }
            
            saveData('teams');
            updateAllUI();
            showMessage(`üîÑ √Ündret til ${newCount} hold`, '#4ECDC4');
        }

        function shuffleTeams() {
            if (players.length === 0) {
                alert('Ingen spillere at blande');
                return;
            }
            
            if (teams.length === 0) {
                initializeTeams();
            }
            
            teams.forEach(team => team.players = []);
            const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
            
            shuffledPlayers.forEach((player, index) => {
                const teamIndex = index % teams.length;
                teams[teamIndex].players.push(player);
            });
            
            saveData('teams');
            updateAllUI();
            showMessage('Hold blandet!', '#4ECDC4');
        }

        function resetTeams() {
            if (teams.length === 0) {
                alert('Ingen hold at nulstille');
                return;
            }
            
            if (confirm('Nulstil alle hold?')) {
                teams.forEach(team => team.players = []);
                saveData('teams');
                updateAllUI();
                showMessage('Hold nulstillet', '#FF9A42');
            }
        }

        function autoDistributeTeams() {
            if (players.length === 0) {
                alert('Ingen spillere at fordele');
                return;
            }
            
            if (teams.length === 0) {
                initializeTeams();
            }
            
            teams.forEach(team => team.players = []);
            
            players.forEach((player, index) => {
                const teamIndex = index % teams.length;
                teams[teamIndex].players.push(player);
            });
            
            saveData('teams');
            updateAllUI();
            showMessage('Spillere auto-fordelt!', '#4ECDC4');
        }

        function initializeTeams() {
            teams = [];
            teamNames = [];
            
            for (let i = 0; i < desiredTeamCount; i++) {
                const teamName = `Hold ${i + 1}`;
                teams.push({
                    id: i + 1,
                    name: teamName,
                    players: []
                });
                teamNames.push(teamName);
            }
        }

        // Game Management
        function addGameAndOpenPopup() {
            const gameName = gameNameInput.value.trim();
            
            if (gameName === '') {
                showMessage('‚ö†Ô∏è Indtast et spil navn', '#FF9A42');
                return;
            }
            
            if (teams.length < 2) {
                showMessage('‚ö†Ô∏è Minimum 2 hold kr√¶vet for at spille', '#FF9A42');
                return;
            }
            
            if (games.some(game => game.name.toLowerCase() === gameName.toLowerCase())) {
                showMessage('‚ö†Ô∏è Dette spil findes allerede', '#FF9A42');
                return;
            }
            
            const newGame = {
                id: generateId(),
                name: gameName,
                status: 'active',
                results: null,
                createdAt: Date.now()
            };
            
            games.push(newGame);
            currentGame = newGame;
            
            gameNameInput.value = '';
            addGameBtn.disabled = true;
            
            openResultsPopup();
            showMessage(`‚úÖ "${gameName}" tilf√∏jet - indtast resultater`, '#4ECDC4');
        }

        function openResultsPopup() {
            if (!currentGame) return;
            
            selectedResults = { first: null, second: null, third: null };
            modalGameName.textContent = currentGame.name;
            
            generateTeamButtons();
            
            if (teams.length === 2) {
                thirdPlaceCard.style.display = 'none';
            } else {
                thirdPlaceCard.style.display = 'block';
            }
            
            resultsModal.classList.add('active');
            saveResultBtn.disabled = true;
        }

        function closeResultsModal() {
            resultsModal.classList.remove('active');
            
            if (currentGame && currentGame.status === 'active' && !currentGame.results) {
                games = games.filter(g => g.id !== currentGame.id);
            }
            
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            saveResultBtn.disabled = true;
            
            updateAllUI();
        }

        function generateTeamButtons() {
            const buttonHTML = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace(${team.id}, 'first')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            firstPlaceButtons.innerHTML = buttonHTML;
            
            const buttonHTML2 = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace(${team.id}, 'second')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            secondPlaceButtons.innerHTML = buttonHTML2;
            
            if (teams.length > 2) {
                const buttonHTML3 = teams.map(team => `
                    <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace(${team.id}, 'third')">
                        ${escapeHtml(team.name)} (${team.players.length} spillere)
                    </button>
                `).join('');
                thirdPlaceButtons.innerHTML = buttonHTML3;
            }
        }

        function selectTeamForPlace(teamId, place) {
            selectedResults[place] = teamId;
            updateTeamButtonStates();
            
            const canSave = teams.length === 2 ? 
                (selectedResults.first !== null && selectedResults.second !== null) :
                (selectedResults.first !== null && selectedResults.second !== null && selectedResults.third !== null);
            
            saveResultBtn.disabled = !canSave;
        }

        function updateTeamButtonStates() {
            firstPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = parseInt(btn.dataset.teamId);
                btn.classList.toggle('selected', selectedResults.first === teamId);
                btn.disabled = (selectedResults.second === teamId || selectedResults.third === teamId);
            });
            
            secondPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = parseInt(btn.dataset.teamId);
                btn.classList.toggle('selected', selectedResults.second === teamId);
                btn.disabled = (selectedResults.first === teamId || selectedResults.third === teamId);
            });
            
            if (teams.length > 2) {
                thirdPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                    const teamId = parseInt(btn.dataset.teamId);
                    btn.classList.toggle('selected', selectedResults.third === teamId);
                    btn.disabled = (selectedResults.first === teamId || selectedResults.second === teamId);
                });
            }
        }

        function saveGameResult() {
            if (!currentGame) return;
            
            if (teams.length === 2) {
                if (!selectedResults.first || !selectedResults.second) {
                    showMessage('‚ö†Ô∏è V√¶lg b√•de 1. og 2. plads', '#FF9A42');
                    return;
                }
                selectedResults.third = null;
            } else {
                if (!selectedResults.first || !selectedResults.second || !selectedResults.third) {
                    showMessage('‚ö†Ô∏è V√¶lg alle tre placeringer', '#FF9A42');
                    return;
                }
            }
            
            const results = [];
            
            const firstTeam = teams.find(t => t.id === selectedResults.first);
            results.push({
                teamId: selectedResults.first,
                teamName: firstTeam.name,
                placement: 1,
                points: 2
            });
            
            const secondTeam = teams.find(t => t.id === selectedResults.second);
            results.push({
                teamId: selectedResults.second,
                teamName: secondTeam.name,
                placement: 2,
                points: 1
            });
            
            if (teams.length > 2 && selectedResults.third) {
                const thirdTeam = teams.find(t => t.id === selectedResults.third);
                results.push({
                    teamId: selectedResults.third,
                    teamName: thirdTeam.name,
                    placement: 3,
                    points: 0
                });
            }
            
            const placedTeamIds = [selectedResults.first, selectedResults.second, selectedResults.third].filter(id => id !== null);
            teams.forEach(team => {
                if (!placedTeamIds.includes(team.id)) {
                    results.push({
                        teamId: team.id,
                        teamName: team.name,
                        placement: teams.length > 2 ? 4 : 3,
                        points: 0
                    });
                }
            });
            
            currentGame.results = results;
            currentGame.status = 'completed';
            currentGame.completedAt = Date.now();
            
            saveData('games');
            
            resultsModal.classList.remove('active');
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            
            updateAllUI();
            showMessage(`‚úÖ Resultat gemt!`, '#4ECDC4');
            
            gameNameInput.focus();
        }

        // Photo Management
        function handlePhotoUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photo = {
                            id: generateId(),
                            name: file.name,
                            data: e.target.result,
                            timestamp: Date.now(),
                            type: 'upload'
                        };
                        
                        photos.push(photo);
                        saveData('photos');
                        updatePhotosUI();
                        showMessage('üì∏ Billede uploadet!', '#4ECDC4');
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function takeGroupPhoto() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Create video element
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();
                        
                        // Create camera interface
                        const cameraDiv = document.createElement('div');
                        cameraDiv.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: black;
                            z-index: 10000;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                        `;
                        
                        video.style.cssText = `
                            max-width: 90%;
                            max-height: 70%;
                            border-radius: 10px;
                        `;
                        
                        const buttonDiv = document.createElement('div');
                        buttonDiv.style.cssText = `
                            margin-top: 20px;
                            display: flex;
                            gap: 20px;
                        `;
                        
                        const captureBtn = document.createElement('button');
                        captureBtn.textContent = 'üì∏ Tag Billede';
                        captureBtn.style.cssText = `
                            background: #4ECDC4;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 16px;
                            cursor: pointer;
                        `;
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = '‚ùå Annuller';
                        cancelBtn.style.cssText = `
                            background: #FF6B6B;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 16px;
                            cursor: pointer;
                        `;
                        
                        captureBtn.onclick = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0);
                            
                            const photo = {
                                id: generateId(),
                                name: `Gruppe billede ${new Date().toLocaleString()}`,
                                data: canvas.toDataURL('image/jpeg'),
                                timestamp: Date.now(),
                                type: 'camera'
                            };
                            
                            photos.push(photo);
                            saveData('photos');
                            updatePhotosUI();
                            showMessage('üì∏ Gruppe billede taget!', '#4ECDC4');
                            
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraDiv);
                        };
                        
                        cancelBtn.onclick = function() {
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraDiv);
                        };
                        
                        buttonDiv.appendChild(captureBtn);
                        buttonDiv.appendChild(cancelBtn);
                        cameraDiv.appendChild(video);
                        cameraDiv.appendChild(buttonDiv);
                        document.body.appendChild(cameraDiv);
                    })
                    .catch(function(err) {
                        alert('Kamera ikke tilg√¶ngeligt: ' + err.message);
                    });
            } else {
                alert('Kamera ikke underst√∏ttet i denne browser');
            }
        }

        // Data Management
        function saveData(type) {
            try {
                switch (type) {
                    case 'players':
                        localStorage.setItem('bakken-players', JSON.stringify(players));
                        if (window.syncManager && window.syncManager.syncPlayers) {
                            window.syncManager.syncPlayers(players);
                        }
                        break;
                    case 'teams':
                        const teamsData = { teams: teams, teamNames: teamNames };
                        localStorage.setItem('bakken-teams', JSON.stringify(teamsData));
                        if (window.syncManager && window.syncManager.syncTeams) {
                            window.syncManager.syncTeams(teamsData);
                        }
                        break;
                    case 'games':
                        const gamesData = { games: games };
                        localStorage.setItem('bakken-games', JSON.stringify(gamesData));
                        if (window.syncManager && window.syncManager.syncGames) {
                            window.syncManager.syncGames(gamesData);
                        }
                        break;
                    case 'photos':
                        localStorage.setItem('bakken-photos', JSON.stringify(photos));
                        break;
                }
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        // UI Updates
        function updateAllUI() {
            updatePlayersUI();
            updateTeamsUI();
            updateGamesUI();
            updatePhotosUI();
        }

        function updatePlayersUI() {
            playerCount.textContent = players.length;
            
            if (players.length === 0) {
                playersList.innerHTML = '<div class="empty-message">Ingen spillere tilf√∏jet endnu</div>';
                clearAllPlayersBtn.style.display = 'none';
            } else {
                playersList.innerHTML = players.map(player => 
                    `<div class="player-item">
                        <span class="player-name">${escapeHtml(player.name)}</span>
                        <button class="remove-btn" onclick="removePlayer('${player.id}')">√ó</button>
                    </div>`
                ).join('');
                clearAllPlayersBtn.style.display = 'inline-block';
            }
        }

        function updateTeamsUI() {
            // Team names grid
            if (teams.length === 0) {
                teamNamesGrid.innerHTML = '<p>Tilf√∏j spillere og opret hold</p>';
                teamsGrid.innerHTML = '<p>Opret hold f√∏rst</p>';
            } else {
                teamNamesGrid.innerHTML = teams.map((team, index) => `
                    <div class="team-name-input">
                        <label for="teamName${index}">Hold ${index + 1}:</label>
                        <input type="text" id="teamName${index}" value="${escapeHtml(team.name)}" 
                               onchange="updateTeamName(${index}, this.value)" maxlength="20">
                    </div>
                `).join('');
                
                teamsGrid.innerHTML = teams.map((team, index) => `
                    <div class="team-card">
                        <div class="team-header">
                            <div class="team-info">
                                <div class="team-color-indicator team-${(index % 12) + 1}-color"></div>
                                <span class="team-name">${escapeHtml(team.name)}</span>
                            </div>
                            <span class="team-count">${(team.players || []).length}</span>
                        </div>
                        <div class="team-players">
                            ${(team.players || []).map(player => `
                                <div class="player-chip">${escapeHtml(player.name)}</div>
                            `).join('')}
                            ${(team.players || []).length === 0 ? '<div class="empty-team-message">Ingen spillere</div>' : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Team count controls
            decreaseTeamsBtn.disabled = desiredTeamCount <= 2;
            increaseTeamsBtn.disabled = desiredTeamCount >= 20;
        }

        function updateGamesUI() {
            // Standings
            if (teams.length === 0) {
                standingsGrid.innerHTML = '<div class="no-teams">Opret hold f√∏rst</div>';
            } else {
                const standings = teams.map(team => {
                    let totalPoints = 0;
                    let gamesPlayed = 0;
                    
                    games.forEach(game => {
                        if (game.status === 'completed' && game.results) {
                            const teamResult = game.results.find(r => r.teamId === team.id);
                            if (teamResult) {
                                totalPoints += teamResult.points;
                                gamesPlayed++;
                            }
                        }
                    });
                    
                    return { ...team, totalPoints, gamesPlayed };
                });
                
                standings.sort((a, b) => b.totalPoints - a.totalPoints);
                
                standingsGrid.innerHTML = standings.map((team, index) => `
                    <div class="team-standing ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                        <div class="standing-position">${index + 1}</div>
                        <div class="standing-info">
                            <div class="standing-team">${escapeHtml(team.name)}</div>
                            <div class="standing-members">${team.players.map(p => p.name).join(', ')}</div>
                            <div class="standing-games">Spil: ${team.gamesPlayed}</div>
                        </div>
                        <div class="standing-score">${team.totalPoints}</div>
                    </div>
                `).join('');
            }
            
            // Completed games
            const completedGamesList = games.filter(g => g.status === 'completed');
            completedCount.textContent = completedGamesList.length;
            
            if (completedGamesList.length === 0) {
                completedGames.innerHTML = '<div class="no-completed"><p>Ingen afsluttede spil endnu</p></div>';
            } else {
                completedGames.innerHTML = completedGamesList.map(game => `
                    <div class="completed-game">
                        <div class="completed-game-info">
                            <div class="completed-game-name">${escapeHtml(game.name)}</div>
                            <div class="completed-game-result">
                                ü•á ${game.results[0].teamName} (2 pt) | 
                                ü•à ${game.results[1].teamName} (1 pt)
                                ${game.results.length > 2 && game.results[2] ? ` | ü•â ${game.results[2].teamName} (0 pt)` : ''}
                            </div>
                        </div>
                        <button class="delete-game-btn" onclick="deleteGame('${game.id}')" title="Slet spil">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('');
            }
        }

        function updatePhotosUI() {
            if (photos.length === 0) {
                photosGrid.innerHTML = '<div class="no-photos"><p>Ingen billeder uploadet endnu</p></div>';
            } else {
                photosGrid.innerHTML = photos.map(photo => `
                    <div class="photo-item">
                        <img src="${photo.data}" alt="${photo.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                        <div class="photo-info">
                            <div class="photo-name">${escapeHtml(photo.name)}</div>
                            <div class="photo-date">${new Date(photo.timestamp).toLocaleString()}</div>
                        </div>
                        <button onclick="deletePhoto('${photo.id}')" class="delete-photo-btn">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        function updateTeamName(index, newName) {
            if (teams[index]) {
                teams[index].name = newName.trim() || `Hold ${index + 1}`;
                teamNames[index] = teams[index].name;
                saveData('teams');
                updateTeamsUI();
                showMessage(`Hold ${index + 1} omd√∏bt`, '#4ECDC4');
            }
        }

        function deleteGame(gameId) {
            const game = games.find(g => g.id === gameId);
            if (game && confirm(`Slet "${game.name}"?`)) {
                games = games.filter(g => g.id !== gameId);
                saveData('games');
                updateGamesUI();
                showMessage(`üóëÔ∏è "${game.name}" slettet`, '#FF9A42');
            }
        }

        function deletePhoto(photoId) {
            if (confirm('Slet billede?')) {
                photos = photos.filter(p => p.id !== photoId);
                saveData('photos');
                updatePhotosUI();
                showMessage('üóëÔ∏è Billede slettet', '#FF9A42');
            }
        }

        function updateSyncStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const syncStatus = document.getElementById('syncStatus');
            
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (status.initialized && status.hasSupabase && status.online) {
                    statusIndicator.textContent = '‚òÅÔ∏è';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = 'üì±';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: ${color}; color: white; padding: 12px 20px;
                border-radius: 8px; z-index: 1000; font-weight: 500;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <style>
        /* Host-specific styles */
        .host-info-card {
            background: linear-gradient(135deg, #FFB366, #FF9A42);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 179, 102, 0.3);
        }

        .host-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .host-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .host-btn.primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .host-btn.primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .host-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .host-btn.danger {
            background: rgba(255, 107, 107, 0.8);
            color: white;
            border: 2px solid rgba(255, 107, 107, 0.5);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #FFB366;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .link-container input {
            font-size: 14px;
            color: #333;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .photo-info {
            padding: 10px;
        }

        .photo-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .photo-date {
            font-size: 0.8rem;
            color: #666;
        }

        .delete-photo-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 107, 107, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
        }

        .photo-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .photo-btn.primary {
            background: #4ECDC4;
            color: white;
        }

        .photo-btn.secondary {
            background: #45B7D1;
            color: white;
        }

        /* Modal styles */
        .results-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .results-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #eee;
            justify-content: flex-end;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .winner-card {
            margin: 15px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
        }

        .place-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .place-medal {
            font-size: 24px;
        }

        .team-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .team-btn {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-btn:hover {
            border-color: #FFB366;
            background: #FFF8F0;
        }

        .team-btn.selected {
            border-color: #FFB366;
            background: #FFB366;
            color: white;
        }

        .team-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: #FFB366;
            color: white;
        }

        .modal-btn.primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }

        @media (max-width: 768px) {
            .host-actions {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
            }
        }
    </style>
</body>
</html>