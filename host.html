<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Håndæg og Håndbajere - Host</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">👑 Håndæg og Håndbajere - HOST</h1>
            <p class="app-subtitle">Komplet Turnerings Kontrol</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">🔄</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Host Info Panel -->
        <section class="host-info-section">
            <div class="host-info-card">
                <h3>👑 Host Kontrol Panel</h3>
                <div class="host-actions">
                    <button onclick="generatePlayerLink()" class="host-btn primary">
                        📱 Generer Spiller Link
                    </button>
                    <button onclick="showTournamentInfo()" class="host-btn secondary">
                        ℹ️ Turnerings Info
                    </button>
                    <button onclick="resetTournament()" class="host-btn danger">
                        🔄 Nulstil Turnering
                    </button>
                </div>
                <div id="playerLinkContainer" style="margin-top: 15px; display: none;">
                    <h4>📱 Spiller Link:</h4>
                    <div class="link-container">
                        <input type="text" id="playerLinkInput" readonly style="width: 100%; padding: 10px; border: 2px solid #4ECDC4; border-radius: 8px; font-family: monospace;">
                        <button onclick="copyPlayerLink()" style="margin-top: 10px; background: #4ECDC4; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            📋 Kopier Link
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <section class="tabs-section">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('players')">👥 Spillere</button>
                <button class="tab-btn" onclick="showTab('teams')">🏆 Hold</button>
                <button class="tab-btn" onclick="showTab('games')">🎮 Spil</button>
                <button class="tab-btn" onclick="showTab('photos')">📸 Billeder</button>
            </div>
        </section>

        <!-- Players Tab -->
        <div id="playersTab" class="tab-content active">
            <section class="input-section">
                <h2 class="section-title">👥 Tilføj Spillere</h2>
                <div class="input-group">
                    <input type="text" 
                           id="playerInput" 
                           placeholder="Indtast spillernavn" 
                           maxlength="30"
                           autocomplete="off">
                    <button id="addPlayerBtn" class="add-btn" disabled>
                        Tilføj Spiller
                    </button>
                </div>
            </section>

            <section class="players-section">
                <h2 class="section-title">
                    Spillere 
                    <span class="player-count" id="playerCount">0</span>
                </h2>
                <div class="players-list" id="playersList">
                    <div class="empty-message">Ingen spillere tilføjet endnu</div>
                </div>
                <button id="clearAllPlayersBtn" class="action-btn secondary" style="display: none;">
                    🗑️ Ryd Alle Spillere
                </button>
            </section>
        </div>

        <!-- Teams Tab -->
        <div id="teamsTab" class="tab-content">
            <!-- Manual Team Creation -->
            <section class="create-team-section">
                <h2 class="section-title">➕ Opret Nyt Hold</h2>
                <div class="create-team-card">
                    <div class="input-group">
                        <input type="text" 
                               id="teamNameInput" 
                               placeholder="Indtast hold navn (f.eks. 'De Vilde', 'Team Rød')" 
                               maxlength="25">
                        <button id="createTeamBtn" class="add-btn" disabled>
                            ➕ Opret Hold
                        </button>
                    </div>
                    <div class="create-team-hint">
                        <small>Opret hold manuelt og tilføj spillere ved at trække dem</small>
                    </div>
                </div>
            </section>

            <!-- Unassigned Players Pool -->
            <section class="unassigned-section">
                <h2 class="section-title">
                    👥 Ikke-tildelte Spillere 
                    <span class="player-count-badge" id="unassignedCount">0</span>
                </h2>
                <div class="players-pool" id="playersPool">
                    <p>Tilføj spillere først</p>
                </div>
            </section>

            <!-- Teams Display -->
            <section class="teams-section">
                <h2 class="section-title">🏆 Oprettede Hold</h2>
                <div class="teams-grid" id="teamsGrid">
                    <div class="no-teams-message">
                        <div class="no-teams-icon">🏆</div>
                        <h3>Ingen hold oprettet endnu</h3>
                        <p>Opret dit første hold ovenfor</p>
                    </div>
                </div>
            </section>

            <!-- Team Actions -->
            <section class="team-actions-section" id="teamActionsSection" style="display: none;">
                <h2 class="section-title">🎲 Hold Handlinger</h2>
                <div class="team-action-buttons">
                    <button id="clearAllTeamsBtn" class="action-btn danger">
                        🗑️ Slet Alle Hold
                    </button>
                </div>
            </section>
        </div>

        <!-- Games Tab -->
        <div id="gamesTab" class="tab-content">
            <section class="standings-section">
                <h2 class="section-title">🏆 Aktuel Stilling</h2>
                <div class="standings-grid" id="standingsGrid">
                    <div class="loading-standings">Opret hold først</div>
                </div>
            </section>

            <section class="add-game-section">
                <h2 class="section-title">➕ Tilføj Nyt Spil</h2>
                <div class="input-group">
                    <input type="text" 
                           id="gameNameInput" 
                           placeholder="Indtast spil navn (f.eks. 'Fodbold', 'Løb', 'Quiz')" 
                           maxlength="50">
                    <button id="addGameBtn" class="add-game-btn" disabled>
                        ➕ Tilføj & Indtast Resultat
                    </button>
                </div>
            </section>

            <section class="completed-section">
                <h2 class="section-title">
                    ✅ Afsluttede Spil 
                    <span class="completed-badge" id="completedCount">0</span>
                </h2>
                <div class="completed-games" id="completedGames">
                    <div class="no-completed">
                        <p>Ingen afsluttede spil endnu</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Photos Tab -->
        <div id="photosTab" class="tab-content">
            <section class="photos-section">
                <h2 class="section-title">📸 Turnerings Billeder</h2>
                <div class="photo-upload">
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                    <button onclick="document.getElementById('photoInput').click()" class="photo-btn primary">
                        📷 Tag Billede / Upload
                    </button>
                    <button onclick="takeGroupPhoto()" class="photo-btn secondary">
                        👥 Gruppe Billede
                    </button>
                </div>
                <div class="photos-grid" id="photosGrid">
                    <div class="no-photos">
                        <p>Ingen billeder uploadet endnu</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="resultsModal">
        <div class="modal-backdrop" onclick="closeResultsModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalGameTitle">🎯 Indtast Resultater</h2>
                <button class="close-btn" onclick="closeResultsModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="game-info">
                    <h3 id="modalGameName">Spil Navn</h3>
                    <p class="scoring-info">🏆 Point System: 1. plads = 2 point, 2. plads = 1 point, 3. plads = 0 point</p>
                </div>
                
                <div class="winner-selection">
                    <div class="winner-card">
                        <div class="place-header">
                            <span class="place-medal">🥇</span>
                            <h4>1. Plads (2 point)</h4>
                        </div>
                        <div class="team-buttons" id="firstPlaceButtons"></div>
                    </div>

                    <div class="winner-card">
                        <div class="place-header">
                            <span class="place-medal">🥈</span>
                            <h4>2. Plads (1 point)</h4>
                        </div>
                        <div class="team-buttons" id="secondPlaceButtons"></div>
                    </div>

                    <div class="winner-card" id="thirdPlaceCard">
                        <div class="place-header">
                            <span class="place-medal">🥉</span>
                            <h4>3. Plads (0 point)</h4>
                        </div>
                        <div class="team-buttons" id="thirdPlaceButtons"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="saveResultBtn" class="modal-btn primary" disabled>
                    💾 Gem Resultat
                </button>
                <button id="cancelResultBtn" class="modal-btn secondary" onclick="closeResultsModal()">
                    ❌ Annuller
                </button>
            </div>
        </div>
    </div>

    <script>
        // Host interface - Manual teams only
        let players = [];
        let teams = [];
        let games = [];
        let photos = [];
        let currentGame = null;
        let selectedResults = { first: null, second: null, third: null };
        let draggedPlayer = null;

        // DOM elements
        const playerInput = document.getElementById('playerInput');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');
        const clearAllPlayersBtn = document.getElementById('clearAllPlayersBtn');
        
        const teamNameInput = document.getElementById('teamNameInput');
        const createTeamBtn = document.getElementById('createTeamBtn');
        const playersPool = document.getElementById('playersPool');
        const teamsGrid = document.getElementById('teamsGrid');
        const unassignedCount = document.getElementById('unassignedCount');
        const teamActionsSection = document.getElementById('teamActionsSection');
        const clearAllTeamsBtn = document.getElementById('clearAllTeamsBtn');
        
        const gameNameInput = document.getElementById('gameNameInput');
        const addGameBtn = document.getElementById('addGameBtn');
        const standingsGrid = document.getElementById('standingsGrid');
        const completedGames = document.getElementById('completedGames');
        const completedCount = document.getElementById('completedCount');
        
        const resultsModal = document.getElementById('resultsModal');
        const modalGameName = document.getElementById('modalGameName');
        const firstPlaceButtons = document.getElementById('firstPlaceButtons');
        const secondPlaceButtons = document.getElementById('secondPlaceButtons');
        const thirdPlaceButtons = document.getElementById('thirdPlaceButtons');
        const thirdPlaceCard = document.getElementById('thirdPlaceCard');
        const saveResultBtn = document.getElementById('saveResultBtn');
        
        const photosGrid = document.getElementById('photosGrid');
        const photoInput = document.getElementById('photoInput');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('👑 Host interface starting...');
            
            // Force host role
            localStorage.setItem('bakken-user-role', 'host');
            
            loadAllData();
            setupEventListeners();
            updateAllUI();
            updateSyncStatus();
        });

        function loadAllData() {
            // Load players
            try {
                const playersData = localStorage.getItem('bakken-players');
                players = playersData ? JSON.parse(playersData) : [];
            } catch (e) {
                players = [];
            }

            // Load teams
            try {
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const parsed = JSON.parse(teamsData);
                    teams = parsed.teams || [];
                }
            } catch (e) {
                teams = [];
            }

            // Load games
            try {
                const gamesData = localStorage.getItem('bakken-games');
                if (gamesData) {
                    const parsed = JSON.parse(gamesData);
                    games = parsed.games || [];
                }
            } catch (e) {
                games = [];
            }

            // Load photos
            try {
                const photosData = localStorage.getItem('bakken-photos');
                photos = photosData ? JSON.parse(photosData) : [];
            } catch (e) {
                photos = [];
            }

            console.log('📥 Loaded data:', {
                players: players.length,
                teams: teams.length,
                games: games.length,
                photos: photos.length
            });
        }

        function setupEventListeners() {
            // Players
            addPlayerBtn.addEventListener('click', addPlayer);
            playerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPlayer();
            });
            playerInput.addEventListener('input', function() {
                addPlayerBtn.disabled = this.value.trim().length === 0;
            });
            clearAllPlayersBtn.addEventListener('click', clearAllPlayers);

            // Teams
            createTeamBtn.addEventListener('click', createTeam);
            teamNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') createTeam();
            });
            teamNameInput.addEventListener('input', function() {
                createTeamBtn.disabled = this.value.trim().length === 0;
            });
            clearAllTeamsBtn.addEventListener('click', clearAllTeams);

            // Games
            addGameBtn.addEventListener('click', addGameAndOpenPopup);
            gameNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addGameAndOpenPopup();
            });
            gameNameInput.addEventListener('input', function() {
                addGameBtn.disabled = this.value.trim().length === 0;
            });
            saveResultBtn.addEventListener('click', saveGameResult);

            // Photos
            photoInput.addEventListener('change', handlePhotoUpload);

            // Modal events
            resultsModal.addEventListener('click', function(e) {
                if (e.target === resultsModal || e.target.classList.contains('modal-backdrop')) {
                    closeResultsModal();
                }
            });

            // Drag and drop events
            document.addEventListener('dragend', function(event) {
                if (event.target.classList.contains('player-chip')) {
                    event.target.style.opacity = '';
                }
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            });

            // Sync events
            setInterval(updateSyncStatus, 3000);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Update UI for current tab
            updateAllUI();
        }

        // Host Functions
        function generatePlayerLink() {
            const baseUrl = window.location.origin + window.location.pathname.replace('host.html', '');
            const playerUrl = baseUrl + 'player.html';
            
            document.getElementById('playerLinkInput').value = playerUrl;
            document.getElementById('playerLinkContainer').style.display = 'block';
            
            showMessage('📱 Spiller link genereret!', '#4ECDC4');
        }

        function copyPlayerLink() {
            const linkInput = document.getElementById('playerLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showMessage('📋 Link kopieret!', '#4ECDC4');
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(linkInput.value).then(() => {
                        showMessage('📋 Link kopieret!', '#4ECDC4');
                    });
                }
            }
        }

        function showTournamentInfo() {
            const info = `🏆 TURNERINGS INFO:
            
👥 Spillere: ${players.length}
🏆 Hold: ${teams.length}
🎮 Spil: ${games.filter(g => g.status === 'completed').length}
📸 Billeder: ${photos.length}

🔗 Tournament ID: ${localStorage.getItem('bakken-tournament-id')}
👑 Rolle: Host`;
            
            alert(info);
        }

        function resetTournament() {
            if (confirm('⚠️ ADVARSEL: Dette vil slette ALT data!\n\nSpillere, hold, spil og billeder vil blive fjernet.\n\nEr du sikker?')) {
                localStorage.removeItem('bakken-players');
                localStorage.removeItem('bakken-teams');
                localStorage.removeItem('bakken-games');
                localStorage.removeItem('bakken-photos');
                
                players = [];
                teams = [];
                games = [];
                photos = [];
                
                updateAllUI();
                showMessage('🔄 Turnering nulstillet', '#FF9A42');
            }
        }

        // Player Management
        function addPlayer() {
            const name = playerInput.value.trim();
            
            if (name === '') {
                showMessage('⚠️ Indtast et spillernavn', '#FF9A42');
                return;
            }
            
            if (players.some(player => player.name.toLowerCase() === name.toLowerCase())) {
                showMessage('⚠️ Spilleren findes allerede', '#FF9A42');
                return;
            }
            
            const newPlayer = {
                id: generateId(),
                name: name
            };
            
            players.push(newPlayer);
            playerInput.value = '';
            addPlayerBtn.disabled = true;
            
            saveData('players');
            updateAllUI();
            showMessage('✅ ' + name + ' tilføjet!', '#4ECDC4');
            
            playerInput.focus();
        }

        function removePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && confirm('Fjern ' + player.name + '?')) {
                players = players.filter(p => p.id !== playerId);
                
                // Remove from teams
                teams.forEach(team => {
                    if (team.players) {
                        team.players = team.players.filter(p => p.id !== playerId);
                    }
                });
                
                saveData('players');
                saveData('teams');
                updateAllUI();
                showMessage('🗑️ ' + player.name + ' fjernet', '#FF9A42');
            }
        }

        function clearAllPlayers() {
            if (players.length === 0) return;
            
            if (confirm('Fjern alle ' + players.length + ' spillere?')) {
                players = [];
                teams = [];
                games = [];
                
                saveData('players');
                saveData('teams');
                saveData('games');
                updateAllUI();
                showMessage('🗑️ Alle spillere fjernet', '#FF9A42');
            }
        }

        // Manual Team Management
        function createTeam() {
            const teamName = teamNameInput.value.trim();
            
            if (teamName === '') {
                showMessage('⚠️ Indtast et hold navn', '#FF9A42');
                return;
            }
            
            if (teams.some(team => team.name.toLowerCase() === teamName.toLowerCase())) {
                showMessage('⚠️ Dette hold navn findes allerede', '#FF9A42');
                return;
            }
            
            const newTeam = {
                id: generateId(),
                name: teamName,
                players: [],
                createdAt: Date.now()
            };
            
            teams.push(newTeam);
            teamNameInput.value = '';
            createTeamBtn.disabled = true;
            
            saveData('teams');
            updateAllUI();
            showMessage('✅ Hold "' + teamName + '" oprettet!', '#4ECDC4');
            
            teamNameInput.focus();
        }

        function deleteTeam(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (team && confirm('Slet hold "' + team.name + '"?\n\nSpillerne vil blive flyttet tilbage til ikke-tildelte.')) {
                teams = teams.filter(t => t.id !== teamId);
                
                saveData('teams');
                updateAllUI();
                showMessage('🗑️ Hold "' + team.name + '" slettet', '#FF9A42');
            }
        }

        function clearAllTeams() {
            if (teams.length === 0) return;
            
            if (confirm('Slet alle ' + teams.length + ' hold?\n\nAlle spillere vil blive flyttet tilbage til ikke-tildelte.')) {
                teams = [];
                
                saveData('teams');
                updateAllUI();
                showMessage('🗑️ Alle hold slettet', '#FF9A42');
            }
        }

        function editTeamName(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            
            const newName = prompt('Nyt navn for holdet:', team.name);
            if (newName && newName.trim() !== '' && newName.trim() !== team.name) {
                const trimmedName = newName.trim();
                
                // Check if name already exists
                if (teams.some(t => t.id !== teamId && t.name.toLowerCase() === trimmedName.toLowerCase())) {
                    showMessage('⚠️ Dette hold navn findes allerede', '#FF9A42');
                    return;
                }
                
                team.name = trimmedName;
                saveData('teams');
                updateAllUI();
                showMessage('✅ Hold omdøbt til "' + trimmedName + '"', '#4ECDC4');
            }
        }

        // Drag and Drop Functions
        function dragStart(event, playerId) {
            draggedPlayer = playerId;
            event.dataTransfer.setData('text/plain', playerId);
            event.target.style.opacity = '0.5';
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dropPlayerToTeam(event, teamId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const playerId = event.dataTransfer.getData('text/plain');
            const player = players.find(p => p.id === playerId);
            
            if (!player) return;
            
            // Remove player from current team
            teams.forEach(team => {
                if (team.players) {
                    team.players = team.players.filter(p => p.id !== playerId);
                }
            });
            
            // Add player to new team
            const targetTeam = teams.find(t => t.id === teamId);
            if (targetTeam) {
                if (!targetTeam.players) targetTeam.players = [];
                targetTeam.players.push(player);
            }
            
            saveData('teams');
            updateAllUI();
            showMessage(`${player.name} flyttet til ${targetTeam.name}`, '#4ECDC4');
        }

        function dropPlayerToPool(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const playerId = event.dataTransfer.getData('text/plain');
            const player = players.find(p => p.id === playerId);
            
            if (!player) return;
            
            // Remove player from all teams
            teams.forEach(team => {
                if (team.players) {
                    team.players = team.players.filter(p => p.id !== playerId);
                }
            });
            
            saveData('teams');
            updateAllUI();
            showMessage(`${player.name} flyttet til ikke-tildelte`, '#4ECDC4');
        }

        // Game Management
        function addGameAndOpenPopup() {
            const gameName = gameNameInput.value.trim();
            
            if (gameName === '') {
                showMessage('⚠️ Indtast et spil navn', '#FF9A42');
                return;
            }
            
            if (teams.length < 2) {
                showMessage('⚠️ Minimum 2 hold krævet for at spille', '#FF9A42');
                return;
            }
            
            if (games.some(game => game.name.toLowerCase() === gameName.toLowerCase())) {
                showMessage('⚠️ Dette spil findes allerede', '#FF9A42');
                return;
            }
            
            const newGame = {
                id: generateId(),
                name: gameName,
                status: 'active',
                results: null,
                createdAt: Date.now()
            };
            
            games.push(newGame);
            currentGame = newGame;
            
            gameNameInput.value = '';
            addGameBtn.disabled = true;
            
            openResultsPopup();
            showMessage(`✅ "${gameName}" tilføjet - indtast resultater`, '#4ECDC4');
        }

        function openResultsPopup() {
            if (!currentGame) return;
            
            selectedResults = { first: null, second: null, third: null };
            modalGameName.textContent = currentGame.name;
            
            generateTeamButtons();
            
            if (teams.length === 2) {
                thirdPlaceCard.style.display = 'none';
            } else {
                thirdPlaceCard.style.display = 'block';
            }
            
            resultsModal.classList.add('active');
            saveResultBtn.disabled = true;
        }

        function closeResultsModal() {
            resultsModal.classList.remove('active');
            
            if (currentGame && currentGame.status === 'active' && !currentGame.results) {
                games = games.filter(g => g.id !== currentGame.id);
            }
            
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            saveResultBtn.disabled = true;
            
            updateAllUI();
        }

        function generateTeamButtons() {
            const buttonHTML = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'first')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            firstPlaceButtons.innerHTML = buttonHTML;
            
            const buttonHTML2 = teams.map(team => `
                <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'second')">
                    ${escapeHtml(team.name)} (${team.players.length} spillere)
                </button>
            `).join('');
            secondPlaceButtons.innerHTML = buttonHTML2;
            
            if (teams.length > 2) {
                const buttonHTML3 = teams.map(team => `
                    <button class="team-btn" data-team-id="${team.id}" onclick="selectTeamForPlace('${team.id}', 'third')">
                        ${escapeHtml(team.name)} (${team.players.length} spillere)
                    </button>
                `).join('');
                thirdPlaceButtons.innerHTML = buttonHTML3;
            }
        }

        function selectTeamForPlace(teamId, place) {
            selectedResults[place] = teamId;
            updateTeamButtonStates();
            
            const canSave = teams.length === 2 ? 
                (selectedResults.first !== null && selectedResults.second !== null) :
                (selectedResults.first !== null && selectedResults.second !== null && selectedResults.third !== null);
            
            saveResultBtn.disabled = !canSave;
        }

        function updateTeamButtonStates() {
            firstPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = btn.dataset.teamId;
                btn.classList.toggle('selected', selectedResults.first === teamId);
                btn.disabled = (selectedResults.second === teamId || selectedResults.third === teamId);
            });
            
            secondPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                const teamId = btn.dataset.teamId;
                btn.classList.toggle('selected', selectedResults.second === teamId);
                btn.disabled = (selectedResults.first === teamId || selectedResults.third === teamId);
            });
            
            if (teams.length > 2) {
                thirdPlaceButtons.querySelectorAll('.team-btn').forEach(btn => {
                    const teamId = btn.dataset.teamId;
                    btn.classList.toggle('selected', selectedResults.third === teamId);
                    btn.disabled = (selectedResults.first === teamId || selectedResults.second === teamId);
                });
            }
        }

        function saveGameResult() {
            if (!currentGame) return;
            
            if (teams.length === 2) {
                if (!selectedResults.first || !selectedResults.second) {
                    showMessage('⚠️ Vælg både 1. og 2. plads', '#FF9A42');
                    return;
                }
                selectedResults.third = null;
            } else {
                if (!selectedResults.first || !selectedResults.second || !selectedResults.third) {
                    showMessage('⚠️ Vælg alle tre placeringer', '#FF9A42');
                    return;
                }
            }
            
            const results = [];
            
            const firstTeam = teams.find(t => t.id === selectedResults.first);
            results.push({
                teamId: selectedResults.first,
                teamName: firstTeam.name,
                placement: 1,
                points: 2
            });
            
            const secondTeam = teams.find(t => t.id === selectedResults.second);
            results.push({
                teamId: selectedResults.second,
                teamName: secondTeam.name,
                placement: 2,
                points: 1
            });
            
            if (teams.length > 2 && selectedResults.third) {
                const thirdTeam = teams.find(t => t.id === selectedResults.third);
                results.push({
                    teamId: selectedResults.third,
                    teamName: thirdTeam.name,
                    placement: 3,
                    points: 0
                });
            }
            
            const placedTeamIds = [selectedResults.first, selectedResults.second, selectedResults.third].filter(id => id !== null);
            teams.forEach(team => {
                if (!placedTeamIds.includes(team.id)) {
                    results.push({
                        teamId: team.id,
                        teamName: team.name,
                        placement: teams.length > 2 ? 4 : 3,
                        points: 0
                    });
                }
            });
            
            currentGame.results = results;
            currentGame.status = 'completed';
            currentGame.completedAt = Date.now();
            
            saveData('games');
            
            resultsModal.classList.remove('active');
            currentGame = null;
            selectedResults = { first: null, second: null, third: null };
            
            updateAllUI();
            showMessage(`✅ Resultat gemt!`, '#4ECDC4');
            
            gameNameInput.focus();
        }

        // Photo Management
        function handlePhotoUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photo = {
                            id: generateId(),
                            name: file.name,
                            data: e.target.result,
                            timestamp: Date.now(),
                            type: 'upload'
                        };
                        
                        photos.push(photo);
                        saveData('photos');
                        updatePhotosUI();
                        showMessage('📸 Billede uploadet!', '#4ECDC4');
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function takeGroupPhoto() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Create video element
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();
                        
                        // Create camera interface
                        const cameraDiv = document.createElement('div');
                        cameraDiv.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: black;
                            z-index: 10000;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                        `;
                        
                        video.style.cssText = `
                            max-width: 90%;
                            max-height: 70%;
                            border-radius: 10px;
                        `;
                        
                        const buttonDiv = document.createElement('div');
                        buttonDiv.style.cssText = `
                            margin-top: 20px;
                            display: flex;
                            gap: 20px;
                        `;
                        
                        const captureBtn = document.createElement('button');
                        captureBtn.textContent = '📸 Tag Billede';
                        captureBtn.style.cssText = `
                            background: #4ECDC4;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 16px;
                            cursor: pointer;
                        `;
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = '❌ Annuller';
                        cancelBtn.style.cssText = `
                            background: #FF6B6B;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 16px;
                            cursor: pointer;
                        `;
                        
                        captureBtn.onclick = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0);
                            
                            const photo = {
                                id: generateId(),
                                name: `Gruppe billede ${new Date().toLocaleString()}`,
                                data: canvas.toDataURL('image/jpeg'),
                                timestamp: Date.now(),
                                type: 'camera'
                            };
                            
                            photos.push(photo);
                            saveData('photos');
                            updatePhotosUI();
                            showMessage('📸 Gruppe billede taget!', '#4ECDC4');
                            
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraDiv);
                        };
                        
                        cancelBtn.onclick = function() {
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraDiv);
                        };
                        
                        buttonDiv.appendChild(captureBtn);
                        buttonDiv.appendChild(cancelBtn);
                        cameraDiv.appendChild(video);
                        cameraDiv.appendChild(buttonDiv);
                        document.body.appendChild(cameraDiv);
                    })
                    .catch(function(err) {
                        alert('Kamera ikke tilgængeligt: ' + err.message);
                    });
            } else {
                alert('Kamera ikke understøttet i denne browser');
            }
        }

        // Data Management
        function saveData(type) {
            try {
                switch (type) {
                    case 'players':
                        localStorage.setItem('bakken-players', JSON.stringify(players));
                        if (window.syncManager && window.syncManager.syncPlayers) {
                            window.syncManager.syncPlayers(players);
                        }
                        break;
                    case 'teams':
                        const teamsData = { teams: teams, teamNames: teams.map(t => t.name) };
                        localStorage.setItem('bakken-teams', JSON.stringify(teamsData));
                        if (window.syncManager && window.syncManager.syncTeams) {
                            window.syncManager.syncTeams(teamsData);
                        }
                        break;
                    case 'games':
                        const gamesData = { games: games };
                        localStorage.setItem('bakken-games', JSON.stringify(gamesData));
                        if (window.syncManager && window.syncManager.syncGames) {
                            window.syncManager.syncGames(gamesData);
                        }
                        break;
                    case 'photos':
                        localStorage.setItem('bakken-photos', JSON.stringify(photos));
                        break;
                }
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        // UI Updates
        function updateAllUI() {
            updatePlayersUI();
            updateTeamsUI();
            updateGamesUI();
            updatePhotosUI();
        }

        function updatePlayersUI() {
            playerCount.textContent = players.length;
            
            if (players.length === 0) {
                playersList.innerHTML = '<div class="empty-message">Ingen spillere tilføjet endnu</div>';
                clearAllPlayersBtn.style.display = 'none';
            } else {
                playersList.innerHTML = players.map(player => 
                    `<div class="player-item">
                        <span class="player-name">${escapeHtml(player.name)}</span>
                        <button class="remove-btn" onclick="removePlayer('${player.id}')">×</button>
                    </div>`
                ).join('');
                clearAllPlayersBtn.style.display = 'inline-block';
            }
        }

        function updateTeamsUI() {
            // Update unassigned players pool
            const unassignedPlayers = getUnassignedPlayers();
            unassignedCount.textContent = unassignedPlayers.length;
            
            if (unassignedPlayers.length === 0 && players.length > 0) {
                playersPool.innerHTML = '<p>Alle spillere er tildelt hold</p>';
            } else if (players.length === 0) {
                playersPool.innerHTML = '<p>Tilføj spillere først</p>';
            } else {
                playersPool.innerHTML = `
                    <div class="players-pool-container" 
                         ondrop="dropPlayerToPool(event)" 
                         ondragover="allowDrop(event)">
                        ${unassignedPlayers.map(player => `
                            <div class="player-chip" 
                                 draggable="true" 
                                 data-player-id="${player.id}"
                                 ondragstart="dragStart(event, '${player.id}')">
                                ${escapeHtml(player.name)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Update teams grid
            if (teams.length === 0) {
                teamsGrid.innerHTML = `
                    <div class="no-teams-message">
                        <div class="no-teams-icon">🏆</div>
                        <h3>Ingen hold oprettet endnu</h3>
                        <p>Opret dit første hold ovenfor</p>
                    </div>
                `;
                teamActionsSection.style.display = 'none';
            } else {
                teamsGrid.innerHTML = teams.map((team, index) => `
                    <div class="team-card">
                        <div class="team-header">
                            <div class="team-info">
                                <div class="team-color-indicator team-${(index % 12) + 1}-color"></div>
                                <span class="team-name">${escapeHtml(team.name)}</span>
                            </div>
                            <div class="team-actions">
                                <button class="team-action-btn edit" onclick="editTeamName('${team.id}')" title="Rediger navn">
                                    ✏️
                                </button>
                                <button class="team-action-btn delete" onclick="deleteTeam('${team.id}')" title="Slet hold">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        <div class="team-players-container" 
                             ondrop="dropPlayerToTeam(event, '${team.id}')" 
                             ondragover="allowDrop(event)">
                            <div class="team-count">${(team.players || []).length} spillere</div>
                            <div class="team-players">
                                ${(team.players || []).map(player => `
                                    <div class="player-chip in-team-${(index % 12) + 1}" 
                                         draggable="true" 
                                         data-player-id="${player.id}"
                                         ondragstart="dragStart(event, '${player.id}')">
                                        ${escapeHtml(player.name)}
                                    </div>
                                `).join('')}
                                ${(team.players || []).length === 0 ? '<div class="empty-team-message">Træk spillere hertil</div>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                teamActionsSection.style.display = 'block';
            }
        }

        function updateGamesUI() {
            // Standings
            if (teams.length === 0) {
                standingsGrid.innerHTML = '<div class="no-teams">Opret hold først</div>';
            } else {
                const standings = teams.map(team => {
                    let totalPoints = 0;
                    let gamesPlayed = 0;
                    
                    games.forEach(game => {
                        if (game.status === 'completed' && game.results) {
                            const teamResult = game.results.find(r => r.teamId === team.id);
                            if (teamResult) {
                                totalPoints += teamResult.points;
                                gamesPlayed++;
                            }
                        }
                    });
                    
                    return { ...team, totalPoints, gamesPlayed };
                });
                
                standings.sort((a, b) => b.totalPoints - a.totalPoints);
                
                standingsGrid.innerHTML = standings.map((team, index) => `
                    <div class="team-standing ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                        <div class="standing-position">${index + 1}</div>
                        <div class="standing-info">
                            <div class="standing-team">${escapeHtml(team.name)}</div>
                            <div class="standing-members">${team.players.map(p => p.name).join(', ')}</div>
                            <div class="standing-games">Spil: ${team.gamesPlayed}</div>
                        </div>
                        <div class="standing-score">${team.totalPoints}</div>
                    </div>
                `).join('');
            }
            
            // Completed games
            const completedGamesList = games.filter(g => g.status === 'completed');
            completedCount.textContent = completedGamesList.length;
            
            if (completedGamesList.length === 0) {
                completedGames.innerHTML = '<div class="no-completed"><p>Ingen afsluttede spil endnu</p></div>';
            } else {
                completedGames.innerHTML = completedGamesList.map(game => `
                    <div class="completed-game">
                        <div class="completed-game-info">
                            <div class="completed-game-name">${escapeHtml(game.name)}</div>
                            <div class="completed-game-result">
                                🥇 ${game.results[0].teamName} (2 pt) | 
                                🥈 ${game.results[1].teamName} (1 pt)
                                ${game.results.length > 2 && game.results[2] ? ` | 🥉 ${game.results[2].teamName} (0 pt)` : ''}
                            </div>
                        </div>
                        <button class="delete-game-btn" onclick="deleteGame('${game.id}')" title="Slet spil">
                            🗑️
                        </button>
                    </div>
                `).join('');
            }
        }

        function updatePhotosUI() {
            if (photos.length === 0) {
                photosGrid.innerHTML = '<div class="no-photos"><p>Ingen billeder uploadet endnu</p></div>';
            } else {
                photosGrid.innerHTML = photos.map(photo => `
                    <div class="photo-item">
                        <img src="${photo.data}" alt="${photo.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                        <div class="photo-info">
                            <div class="photo-name">${escapeHtml(photo.name)}</div>
                            <div class="photo-date">${new Date(photo.timestamp).toLocaleString()}</div>
                        </div>
                        <button onclick="deletePhoto('${photo.id}')" class="delete-photo-btn">🗑️</button>
                    </div>
                `).join('');
            }
        }

        function getUnassignedPlayers() {
            const assignedPlayerIds = teams.flatMap(team => 
                (team.players || []).map(p => p.id)
            );
            return players.filter(player => !assignedPlayerIds.includes(player.id));
        }

        function deleteGame(gameId) {
            const game = games.find(g => g.id === gameId);
            if (game && confirm(`Slet "${game.name}"?`)) {
                games = games.filter(g => g.id !== gameId);
                saveData('games');
                updateGamesUI();
                showMessage(`🗑️ "${game.name}" slettet`, '#FF9A42');
            }
        }

        function deletePhoto(photoId) {
            if (confirm('Slet billede?')) {
                photos = photos.filter(p => p.id !== photoId);
                saveData('photos');
                updatePhotosUI();
                showMessage('🗑️ Billede slettet', '#FF9A42');
            }
        }

        function updateSyncStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const syncStatus = document.getElementById('syncStatus');
            
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (status.initialized && status.hasSupabase && status.online) {
                    statusIndicator.textContent = '☁️';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = '📱';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: ${color}; color: white; padding: 12px 20px;
                border-radius: 8px; z-index: 1000; font-weight: 500;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <style>
        /* Manual teams specific styles */
        .create-team-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #4ECDC4;
        }

        .create-team-hint {
            margin-top: 10px;
            color: #666;
        }

        .no-teams-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
        }

        .no-teams-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .team-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }

        .team-card:hover {
            border-color: #4ECDC4;
            transform: translateY(-2px);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .team-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .team-actions {
            display: flex;
            gap: 8px;
        }

        .team-action-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .team-action-btn.edit:hover {
            background: rgba(69, 183, 209, 0.1);
        }

        .team-action-btn.delete:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .team-players-container {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .team-players-container.drag-over {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
        }

        .team-count {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .team-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .players-pool-container {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .players-pool-container.drag-over {
            border-color: #FF9A42;
            background: rgba(255, 154, 66, 0.1);
        }

        .player-chip {
            background: #f0f8ff;
            color: #45B7D1;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            border: 1px solid #e0f0ff;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .player-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-chip.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .empty-team-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin: 10px 0;
            background: #f9f9f9;
        }

        .team-actions-section {
            margin: 30px 0;
        }

        .team-action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Team colors */
        .team-1-color { background: #FF6B6B; }
        .team-2-color { background: #4ECDC4; }
        .team-3-color { background: #45B7D1; }
        .team-4-color { background: #96CEB4; }
        .team-5-color { background: #FFEAA7; }
        .team-6-color { background: #DDA0DD; }
        .team-7-color { background: #98D8C8; }
        .team-8-color { background: #F7DC6F; }
        .team-9-color { background: #BB8FCE; }
        .team-10-color { background: #85C1E9; }
        .team-11-color { background: #F8C471; }
        .team-12-color { background: #82E0AA; }

        .in-team-1 { background: #FF6B6B; color: white; }
        .in-team-2 { background: #4ECDC4; color: white; }
        .in-team-3 { background: #45B7D1; color: white; }
        .in-team-4 { background: #96CEB4; color: white; }
        .in-team-5 { background: #FFEAA7; color: #333; }
        .in-team-6 { background: #DDA0DD; color: white; }
        .in-team-7 { background: #98D8C8; color: white; }
        .in-team-8 { background: #F7DC6F; color: #333; }
        .in-team-9 { background: #BB8FCE; color: white; }
        .in-team-10 { background: #85C1E9; color: white; }
        .in-team-11 { background: #F8C471; color: #333; }
        .in-team-12 { background: #82E0AA; color: white; }

        /* Rest of the styles remain the same as previous version */
        .host-info-card {
            background: linear-gradient(135deg, #FFB366, #FF9A42);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 179, 102, 0.3);
        }

        .host-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .host-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .host-btn.primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .host-btn.primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .host-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .host-btn.danger {
            background: rgba(255, 107, 107, 0.8);
            color: white;
            border: 2px solid rgba(255, 107, 107, 0.5);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #FFB366;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .host-actions {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
            }

            .team-action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</body>
</html>