<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√•nd√¶g og H√•ndbajere - Hold</title>
    <link rel="stylesheet" href="teams-styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">üèà H√•nd√¶g og H√•ndbajere</h1>
            <p class="app-subtitle">Opret Hold</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">üîÑ</span>
                <span class="status-text" id="statusText">Loading...</span>
            </div>
        </header>

        <!-- Navigation -->
        <section class="navigation-section">
            <a href="index.html" class="nav-btn">‚Üê Tilbage til Spillere</a>
        </section>

        <!-- Loading State -->
        <div id="loadingState" class="loading-section">
            <div class="loading-card">
                <div class="loading-spinner">üîÑ</div>
                <h3>Indl√¶ser spillere...</h3>
                <p>Henter data fra skyen</p>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Team Names Section -->
            <section class="team-names-section">
                <h2 class="section-title">Hold Navne</h2>
                <div class="team-names-grid" id="teamNamesGrid">
                    <!-- Team name inputs will be generated here -->
                </div>
            </section>

            <!-- Controls Section -->
            <section class="controls-section">
                <h2 class="section-title">Handlinger</h2>
                <div class="control-buttons">
                    <button id="shuffleBtn" class="control-btn primary">üîÄ Bland Hold</button>
                    <button id="resetBtn" class="control-btn secondary">üîÑ Nulstil</button>
                </div>
            </section>

            <!-- Unassigned Players Section -->
            <section class="unassigned-section">
                <h2 class="section-title">
                    Ikke-tildelte Spillere 
                    <span class="player-count-badge" id="unassignedCount">0</span>
                </h2>
                <div class="players-pool" id="playersPool">
                    <!-- Unassigned players will appear here -->
                </div>
            </section>

            <!-- Teams Section -->
            <section class="teams-section">
                <div class="teams-grid" id="teamsGrid">
                    <!-- Team cards will be generated here -->
                </div>
            </section>

            <!-- Action Section -->
            <section class="action-section">
                <a href="games.html" id="continueBtn" class="continue-btn disabled">
                    Forts√¶t til Spil
                </a>
                <p class="requirement-text" id="requirementText">
                    Alle spillere skal v√¶re tildelt et hold
                </p>
            </section>
        </div>

        <!-- No Players State -->
        <div id="noPlayersState" style="display: none;">
            <div class="no-players-card">
                <div class="no-players-icon">üë•</div>
                <h3>Ingen spillere fundet</h3>
                <p>Du skal tilf√∏je spillere f√∏rst</p>
                <a href="index.html" class="nav-btn primary">Tilf√∏j Spillere</a>
            </div>
        </div>
    </div>

    <script>
        // Teams management with proper initialization
        let players = [];
        let teams = [];
        let teamNames = ['Hold 1', 'Hold 2', 'Hold 3'];
        let draggedPlayer = null;
        let isDataLoaded = false;
        let loadingTimeout = null;

        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const mainContent = document.getElementById('mainContent');
        const noPlayersState = document.getElementById('noPlayersState');
        const teamNamesGrid = document.getElementById('teamNamesGrid');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const resetBtn = document.getElementById('resetBtn');
        const playersPool = document.getElementById('playersPool');
        const teamsGrid = document.getElementById('teamsGrid');
        const continueBtn = document.getElementById('continueBtn');
        const requirementText = document.getElementById('requirementText');
        const unassignedCount = document.getElementById('unassignedCount');
        const syncStatus = document.getElementById('syncStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Teams page starting...');
            
            showLoadingState();
            setupEventListeners();
            updateSyncStatus();
            
            // Set timeout for loading
            loadingTimeout = setTimeout(() => {
                console.log('‚è∞ Loading timeout - using local data');
                finishLoading();
            }, 5000);
            
            // Start data loading process
            initializeData();
        });

        async function initializeData() {
            try {
                // Step 1: Load local data first
                loadLocalData();
                
                // Step 2: Initialize teams if needed
                ensureTeamsInitialized();
                
                // Step 3: Initialize sync manager if available
                if (window.syncManager) {
                    try {
                        await window.syncManager.initialize();
                        console.log('‚úÖ Sync manager ready');
                        
                        // Step 4: Try to load fresh data from cloud
                        await loadCloudData();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Sync manager initialization failed:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è No sync manager available');
                }
                
                // Step 5: Finalize loading
                finishLoading();
                
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
                finishLoading();
            }
        }

        function loadLocalData() {
            try {
                // Load players from localStorage
                const playersData = localStorage.getItem('bakken-players');
                if (playersData) {
                    players = JSON.parse(playersData);
                    console.log('üì• Loaded local players:', players.length);
                } else {
                    players = [];
                    console.log('üì• No players found in localStorage');
                }

                // Load teams from localStorage
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    try {
                        const savedData = JSON.parse(teamsData);
                        teams = Array.isArray(savedData.teams) ? savedData.teams : [];
                        teamNames = Array.isArray(savedData.teamNames) ? savedData.teamNames : ['Hold 1', 'Hold 2', 'Hold 3'];
                        console.log('üì• Loaded local teams:', teams.length);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Invalid teams data, initializing fresh');
                        teams = [];
                        teamNames = ['Hold 1', 'Hold 2', 'Hold 3'];
                    }
                } else {
                    teams = [];
                    teamNames = ['Hold 1', 'Hold 2', 'Hold 3'];
                    console.log('üì• No teams found in localStorage');
                }
            } catch (e) {
                console.error('‚ùå Error loading local data:', e);
                players = [];
                teams = [];
                teamNames = ['Hold 1', 'Hold 2', 'Hold 3'];
            }
        }

        function ensureTeamsInitialized() {
            // Always ensure teams is an array
            if (!Array.isArray(teams)) {
                teams = [];
            }
            
            // Initialize teams if we have players but no teams
            if (players.length > 0 && teams.length === 0) {
                initializeTeams();
            }
            
            console.log('‚úÖ Teams ensured:', teams.length);
        }

        async function loadCloudData() {
            if (!window.syncManager || !window.syncManager.supabase) {
                console.log('üì± No cloud sync available');
                return;
            }

            try {
                console.log('‚òÅÔ∏è Loading fresh data from cloud...');
                statusText.textContent = 'Loading from cloud...';
                
                const cloudData = await window.syncManager.loadFromCloud();
                
                if (cloudData) {
                    let dataUpdated = false;
                    
                    // Update players from cloud if available
                    if (cloudData.players && Array.isArray(cloudData.players) && cloudData.players.length > 0) {
                        const cleanPlayers = cloudData.players.map(p => ({ 
                            id: p.id, 
                            name: p.name 
                        }));
                        
                        if (cleanPlayers.length !== players.length || 
                            !cleanPlayers.every(cp => players.find(p => p.id === cp.id && p.name === cp.name))) {
                            players = cleanPlayers;
                            localStorage.setItem('bakken-players', JSON.stringify(players));
                            dataUpdated = true;
                            console.log('‚úÖ Updated players from cloud:', players.length);
                        }
                    }
                    
                    // Update teams from cloud if available
                    if (cloudData.teams && cloudData.teams.teams_data) {
                        const cloudTeams = cloudData.teams.teams_data;
                        const cloudTeamNames = cloudData.teams.team_names || ['Hold 1', 'Hold 2', 'Hold 3'];
                        
                        if (Array.isArray(cloudTeams)) {
                            teams = cloudTeams;
                            teamNames = cloudTeamNames;
                            localStorage.setItem('bakken-teams', JSON.stringify({
                                teams: teams,
                                teamNames: teamNames
                            }));
                            dataUpdated = true;
                            console.log('‚úÖ Updated teams from cloud');
                        }
                    }
                    
                    if (dataUpdated) {
                        showMessage('üì• Data updated from cloud', '#4ECDC4');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading cloud data:', error);
                showMessage('‚ö†Ô∏è Using local data only', '#FF9A42');
            }
        }

        function finishLoading() {
            clearTimeout(loadingTimeout);
            isDataLoaded = true;
            
            // Ensure teams are initialized
            ensureTeamsInitialized();
            
            // Show appropriate state
            if (players.length === 0) {
                showNoPlayersState();
            } else {
                showMainContent();
                updateUI();
            }
            
            updateSyncStatus();
        }

        function showLoadingState() {
            loadingState.style.display = 'block';
            mainContent.style.display = 'none';
            noPlayersState.style.display = 'none';
        }

        function showMainContent() {
            loadingState.style.display = 'none';
            mainContent.style.display = 'block';
            noPlayersState.style.display = 'none';
        }

        function showNoPlayersState() {
            loadingState.style.display = 'none';
            mainContent.style.display = 'none';
            noPlayersState.style.display = 'block';
        }

        function initializeTeams() {
            const playerCount = players.length;
            
            if (playerCount === 0) {
                teams = [];
                return;
            }
            
            const teamCount = Math.min(3, Math.max(2, Math.ceil(playerCount / 3)));
            
            teams = [];
            for (let i = 0; i < teamCount; i++) {
                teams.push({
                    id: i + 1,
                    name: teamNames[i] || `Hold ${i + 1}`,
                    players: []
                });
            }
            
            console.log('üèóÔ∏è Initialized teams:', teams.length);
        }

        function saveData() {
            try {
                const teamsData = {
                    teams: teams,
                    teamNames: teamNames,
                    lastUpdated: Date.now()
                };
                
                localStorage.setItem('bakken-teams', JSON.stringify(teamsData));
                localStorage.setItem('bakken-teams-last-update', Date.now().toString());
                console.log('üíæ Saved teams data');
                
                // Sync to cloud
                if (window.syncManager && window.syncManager.isInitialized) {
                    window.syncManager.syncTeams(teamsData);
                }
            } catch (e) {
                console.error('‚ùå Save failed:', e);
            }
        }

        function setupEventListeners() {
            shuffleBtn.addEventListener('click', shuffleTeams);
            resetBtn.addEventListener('click', resetTeams);

            // Listen for remote data updates
            window.addEventListener('bakken-data-updated', function(event) {
                console.log('üîÑ Remote data update:', event.detail);
                
                if (event.detail.table === 'players' && event.detail.source === 'remote') {
                    console.log('üîÑ Players updated from remote');
                    loadLocalData();
                    ensureTeamsInitialized();
                    updateUI();
                    showMessage('üîÑ Players updated from another device', '#45B7D1');
                }
                
                if (event.detail.table === 'teams' && event.detail.source === 'remote') {
                    console.log('üîÑ Teams updated from remote');
                    loadLocalData();
                    updateUI();
                    showMessage('üîÑ Teams updated from another device', '#45B7D1');
                }
            });

            // Listen for sync status changes
            window.addEventListener('sync-status-changed', updateSyncStatus);

            // Update sync status periodically
            setInterval(updateSyncStatus, 3000);
        }

        function updateUI() {
            if (!isDataLoaded) return;
            
            // Ensure teams is always an array before updating UI
            if (!Array.isArray(teams)) {
                teams = [];
                ensureTeamsInitialized();
            }
            
            updateTeamNamesGrid();
            updateTeamsGrid();
            updatePlayersPool();
            updateContinueButton();
            updateUnassignedCount();
        }

        function updateTeamNamesGrid() {
            if (!Array.isArray(teams) || teams.length === 0) {
                teamNamesGrid.innerHTML = '<p>Initialiserer hold...</p>';
                return;
            }
            
            teamNamesGrid.innerHTML = teams.map((team, index) => `
                <div class="team-name-input">
                    <label for="teamName${index}">Hold ${index + 1}:</label>
                    <input type="text" id="teamName${index}" value="${escapeHtml(team.name)}" 
                           onchange="updateTeamName(${index}, this.value)" maxlength="20">
                </div>
            `).join('');
        }

        function updateTeamsGrid() {
            if (!Array.isArray(teams) || teams.length === 0) {
                teamsGrid.innerHTML = '<p>Initialiserer hold...</p>';
                return;
            }
            
            teamsGrid.innerHTML = teams.map((team, index) => `
                <div class="team-card">
                    <div class="team-header">
                        <div class="team-info">
                            <div class="team-color-indicator team-${index + 1}-color"></div>
                            <span class="team-name">${escapeHtml(team.name)}</span>
                        </div>
                        <span class="team-count">${(team.players || []).length}</span>
                    </div>
                    <div class="team-players ${(team.players || []).length === 0 ? 'empty' : ''}" 
                         data-team-id="${team.id}"
                         ondrop="dropPlayer(event, ${team.id})"
                         ondragover="allowDrop(event)">
                        ${(team.players || []).map(player => `
                            <div class="player-chip in-team-${index + 1}" 
                                 draggable="true" 
                                 data-player-id="${player.id}"
                                 ondragstart="dragStart(event, '${player.id}')">
                                ${escapeHtml(player.name)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updatePlayersPool() {
            const unassignedPlayers = getUnassignedPlayers();
            
            if (unassignedPlayers.length === 0) {
                playersPool.innerHTML = '';
                playersPool.classList.add('empty');
            } else {
                playersPool.classList.remove('empty');
                playersPool.innerHTML = unassignedPlayers.map(player => `
                    <div class="player-chip" 
                         draggable="true" 
                         data-player-id="${player.id}"
                         ondragstart="dragStart(event, '${player.id}')">
                        ${escapeHtml(player.name)}
                    </div>
                `).join('');
            }
        }

        function updateUnassignedCount() {
            const count = getUnassignedPlayers().length;
            unassignedCount.textContent = count;
        }

        function updateContinueButton() {
            const unassignedCount = getUnassignedPlayers().length;
            
            if (unassignedCount === 0 && players.length > 0) {
                continueBtn.classList.remove('disabled');
                continueBtn.style.pointerEvents = 'auto';
                requirementText.textContent = 'Klar til at starte spil!';
            } else {
                continueBtn.classList.add('disabled');
                continueBtn.style.pointerEvents = 'none';
                if (players.length === 0) {
                    requirementText.textContent = 'Tilf√∏j spillere f√∏rst';
                } else {
                    requirementText.textContent = `${unassignedCount} spillere skal tildeles hold`;
                }
            }
        }

        function getUnassignedPlayers() {
            if (!Array.isArray(teams) || !Array.isArray(players)) {
                return players || [];
            }
            
            const assignedPlayerIds = teams.flatMap(team => 
                (team.players || []).map(p => p.id)
            );
            return players.filter(player => !assignedPlayerIds.includes(player.id));
        }

        function updateTeamName(index, newName) {
            if (Array.isArray(teams) && teams[index]) {
                teams[index].name = newName.trim() || `Hold ${index + 1}`;
                teamNames[index] = teams[index].name;
                saveData();
                updateTeamsGrid();
                showMessage(`Hold ${index + 1} omd√∏bt til "${teams[index].name}"`, '#4ECDC4');
            }
        }

        function shuffleTeams() {
            if (players.length === 0) {
                alert('Ingen spillere at blande');
                return;
            }
            
            if (!Array.isArray(teams) || teams.length === 0) {
                initializeTeams();
            }
            
            // Clear all teams
            teams.forEach(team => team.players = []);
            
            // Shuffle players
            const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
            
            // Distribute players evenly
            shuffledPlayers.forEach((player, index) => {
                const teamIndex = index % teams.length;
                teams[teamIndex].players.push(player);
            });
            
            saveData();
            updateUI();
            showMessage('Hold blandet!', '#4ECDC4');
        }

        function resetTeams() {
            if (!Array.isArray(teams) || teams.length === 0) {
                alert('Ingen hold at nulstille');
                return;
            }
            
            if (confirm('Nulstil alle hold? Alle spillere vil blive fjernet fra holdene.')) {
                teams.forEach(team => team.players = []);
                saveData();
                updateUI();
                showMessage('Hold nulstillet', '#FF9A42');
            }
        }

        // Drag and Drop functions
        function dragStart(event, playerId) {
            draggedPlayer = playerId;
            event.dataTransfer.setData('text/plain', playerId);
            
            const element = event.target;
            element.classList.add('dragging');
            
            setTimeout(() => {
                if (element.parentNode) {
                    element.style.opacity = '0.5';
                }
            }, 0);
        }

        function allowDrop(event) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function dropPlayer(event, teamId) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');
            
            const playerId = event.dataTransfer.getData('text/plain');
            if (!playerId) return;
            
            // Find the player
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            // Remove player from current team
            teams.forEach(team => {
                if (team.players) {
                    team.players = team.players.filter(p => p.id !== playerId);
                }
            });
            
            // Add player to new team
            const targetTeam = teams.find(t => t.id === teamId);
            if (targetTeam) {
                if (!targetTeam.players) {
                    targetTeam.players = [];
                }
                targetTeam.players.push(player);
            }
            
            saveData();
            updateUI();
            showMessage(`${player.name} flyttet til ${targetTeam.name}`, '#4ECDC4');
        }

        // Handle drag end
        document.addEventListener('dragend', function(event) {
            const draggedElement = document.querySelector('.dragging');
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.opacity = '';
            }
            
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });

        function updateSyncStatus() {
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (!status.initialized) {
                    statusIndicator.textContent = 'üîÑ';
                    statusText.textContent = 'Connecting...';
                    syncStatus.style.background = 'rgba(255, 179, 102, 0.3)';
                } else if (!status.hasSupabase) {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                } else if (!status.online) {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else if (status.pendingSync > 0) {
                    statusIndicator.textContent = '‚è≥';
                    statusText.textContent = `Syncing ${status.pendingSync}...`;
                    syncStatus.style.background = 'rgba(69, 183, 209, 0.3)';
                } else if (status.hasSupabase && status.online) {
                    statusIndicator.textContent = '‚òÅÔ∏è';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = 'üì±';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = 'üì±';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) existingMessage.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideUp 0.3s ease forwards';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add animations
        if (!document.getElementById('teams-animations')) {
            const animationStyle = document.createElement('style');
            animationStyle.id = 'teams-animations';
            animationStyle.textContent = `
                @keyframes slideDown {
                    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    to { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
                
                @keyframes slideUp {
                    from { opacity: 1; transform: translateX(-50%) translateY(0); }
                    to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(animationStyle);
        }

        // Debug function
        window.debugTeams = function() {
            console.log('üîç Debug Teams Data:');
            console.log('Players:', players);
            console.log('Teams:', teams);
            console.log('Is Data Loaded:', isDataLoaded);
            console.log('Local Storage Players:', localStorage.getItem('bakken-players'));
            console.log('Local Storage Teams:', localStorage.getItem('bakken-teams'));
        };

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function() {
            if (Array.isArray(teams) && teams.length > 0) {
                saveData();
            }
        });
    </script>
</body>
</html>