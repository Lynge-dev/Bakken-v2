<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Håndæg og Håndbajere - Hold</title>
    <link rel="stylesheet" href="teams-styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="sync-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">🏈 Håndæg og Håndbajere</h1>
            <p class="app-subtitle">Opret Hold</p>
            <div class="sync-status" id="syncStatus">
                <span class="status-indicator" id="statusIndicator">🔄</span>
                <span class="status-text" id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Navigation -->
        <section class="navigation-section">
            <a href="index.html" class="nav-btn">← Tilbage til Spillere</a>
        </section>

        <!-- Team Names Section -->
        <section class="team-names-section">
            <h2 class="section-title">Hold Navne</h2>
            <div class="team-names-grid" id="teamNamesGrid">
                <!-- Team name inputs will be generated here -->
            </div>
        </section>

        <!-- Controls Section -->
        <section class="controls-section">
            <h2 class="section-title">Handlinger</h2>
            <div class="control-buttons">
                <button id="shuffleBtn" class="control-btn primary">🔀 Bland Hold</button>
                <button id="resetBtn" class="control-btn secondary">🔄 Nulstil</button>
            </div>
        </section>

        <!-- Unassigned Players Section -->
        <section class="unassigned-section">
            <h2 class="section-title">
                Ikke-tildelte Spillere 
                <span class="player-count-badge" id="unassignedCount">0</span>
            </h2>
            <div class="players-pool" id="playersPool">
                <!-- Unassigned players will appear here -->
            </div>
        </section>

        <!-- Teams Section -->
        <section class="teams-section">
            <div class="teams-grid" id="teamsGrid">
                <!-- Team cards will be generated here -->
            </div>
        </section>

        <!-- Action Section -->
        <section class="action-section">
            <a href="games.html" id="continueBtn" class="continue-btn disabled">
                Fortsæt til Spil
            </a>
            <p class="requirement-text" id="requirementText">
                Alle spillere skal være tildelt et hold
            </p>
        </section>
    </div>

    <script>
        // Teams management with sync
        let players = [];
        let teams = [];
        let teamNames = ['Hold 1', 'Hold 2', 'Hold 3'];
        let draggedPlayer = null;
        let dragGhost = null;
        let isDataLoaded = false;

        // DOM elements
        const teamNamesGrid = document.getElementById('teamNamesGrid');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const resetBtn = document.getElementById('resetBtn');
        const playersPool = document.getElementById('playersPool');
        const teamsGrid = document.getElementById('teamsGrid');
        const continueBtn = document.getElementById('continueBtn');
        const requirementText = document.getElementById('requirementText');
        const unassignedCount = document.getElementById('unassignedCount');
        const syncStatus = document.getElementById('syncStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Teams page starting...');
            
            // Show loading state
            showMessage('📥 Loading players...', '#45B7D1');
            
            loadData();
            setupEventListeners();
            updateSyncStatus();
            
            // Initialize sync and load cloud data
            setTimeout(async () => {
                if (window.syncManager) {
                    try {
                        await window.syncManager.initialize();
                        console.log('✅ Sync manager initialized');
                        
                        // Load fresh data from cloud
                        await loadCloudData();
                        
                        updateSyncStatus();
                    } catch (error) {
                        console.error('❌ Sync initialization failed:', error);
                        updateSyncStatus();
                    }
                } else {
                    console.warn('⚠️ Sync manager not available');
                    updateSyncStatus();
                }
                
                // Always update UI after initialization
                updateUI();
                isDataLoaded = true;
            }, 1000);
        });

        async function loadCloudData() {
            if (!window.syncManager || !window.syncManager.supabase) {
                console.log('📱 No cloud sync available, using local data');
                return;
            }

            try {
                console.log('📥 Loading fresh data from cloud...');
                const cloudData = await window.syncManager.loadFromCloud();
                
                if (cloudData) {
                    // Update players from cloud
                    if (cloudData.players && cloudData.players.length > 0) {
                        const cleanPlayers = cloudData.players.map(p => ({ id: p.id, name: p.name }));
                        players = cleanPlayers;
                        localStorage.setItem('bakken-players', JSON.stringify(players));
                        console.log('✅ Updated players from cloud:', players);
                    }
                    
                    // Update teams from cloud
                    if (cloudData.teams) {
                        const savedData = cloudData.teams;
                        teams = savedData.teams || [];
                        teamNames = savedData.teamNames || ['Hold 1', 'Hold 2', 'Hold 3'];
                        localStorage.setItem('bakken-teams', JSON.stringify(savedData));
                        console.log('✅ Updated teams from cloud:', teams);
                    }
                    
                    showMessage('📥 Data loaded from cloud', '#4ECDC4');
                } else {
                    console.log('📱 No cloud data available, using local data');
                }
            } catch (error) {
                console.error('❌ Error loading cloud data:', error);
                showMessage('⚠️ Using local data only', '#FF9A42');
            }
        }

        function loadData() {
            try {
                // Load players
                const playersData = localStorage.getItem('bakken-players');
                if (playersData) {
                    players = JSON.parse(playersData);
                    console.log('📥 Loaded local players:', players);
                }

                // Load teams data
                const teamsData = localStorage.getItem('bakken-teams');
                if (teamsData) {
                    const savedData = JSON.parse(teamsData);
                    teams = savedData.teams || [];
                    teamNames = savedData.teamNames || ['Hold 1', 'Hold 2', 'Hold 3'];
                    console.log('📥 Loaded local teams:', teams);
                    console.log('📥 Loaded local team names:', teamNames);
                } else {
                    // Initialize teams based on player count
                    initializeTeams();
                }

                // Check if we have players
                if (players.length === 0) {
                    console.warn('⚠️ No players found locally');
                }
            } catch (e) {
                console.error('❌ Load failed:', e);
                initializeTeams();
            }
        }

        function saveData() {
            try {
                const teamsData = {
                    teams: teams,
                    teamNames: teamNames,
                    lastUpdated: Date.now()
                };
                
                localStorage.setItem('bakken-teams', JSON.stringify(teamsData));
                localStorage.setItem('bakken-teams-last-update', Date.now().toString());
                console.log('💾 Saved teams data:', teamsData);
                
                // Sync to cloud
                if (window.syncManager && window.syncManager.isInitialized) {
                    window.syncManager.syncTeams(teamsData);
                } else {
                    console.log('📝 Sync manager not ready, data saved locally only');
                }
            } catch (e) {
                console.error('❌ Save failed:', e);
            }
        }

        function initializeTeams() {
            const playerCount = players.length;
            
            if (playerCount === 0) {
                console.log('⚠️ No players to initialize teams with');
                teams = [];
                return;
            }
            
            const teamCount = Math.min(3, Math.max(2, Math.ceil(playerCount / 3)));
            
            teams = [];
            for (let i = 0; i < teamCount; i++) {
                teams.push({
                    id: i + 1,
                    name: teamNames[i] || `Hold ${i + 1}`,
                    players: []
                });
            }
            
            console.log('🏗️ Initialized teams:', teams);
        }

        function setupEventListeners() {
            shuffleBtn.addEventListener('click', shuffleTeams);
            resetBtn.addEventListener('click', resetTeams);

            // Listen for remote data updates
            window.addEventListener('bakken-data-updated', function(event) {
                console.log('🔄 Remote data update:', event.detail);
                
                if (event.detail.table === 'players' && event.detail.source === 'remote') {
                    console.log('🔄 Players updated from remote source');
                    loadData();
                    // Re-initialize teams if needed
                    if (teams.length === 0) {
                        initializeTeams();
                    }
                    updateUI();
                    showMessage('🔄 Players updated from another device', '#45B7D1');
                }
                
                if (event.detail.table === 'teams' && event.detail.source === 'remote') {
                    console.log('🔄 Teams updated from remote source');
                    loadData();
                    updateUI();
                    showMessage('🔄 Teams updated from another device', '#45B7D1');
                }
            });

            // Listen for data loaded from cloud
            window.addEventListener('bakken-data-loaded', function() {
                console.log('📥 Data loaded from cloud event');
                loadData();
                if (teams.length === 0) {
                    initializeTeams();
                }
                updateUI();
            });

            // Listen for sync status changes
            window.addEventListener('sync-status-changed', function(event) {
                console.log('📊 Sync status changed:', event.detail.status);
                updateSyncStatus();
            });

            // Update sync status periodically
            setInterval(updateSyncStatus, 3000);
        }

        function updateUI() {
            // Don't update UI until data is loaded
            if (!isDataLoaded && players.length === 0) {
                console.log('⏳ Waiting for data to load...');
                return;
            }

            updateTeamNamesGrid();
            updateTeamsGrid();
            updatePlayersPool();
            updateContinueButton();
            updateUnassignedCount();
            
            // Show warning if no players
            if (players.length === 0) {
                showMessage('⚠️ Ingen spillere fundet. Gå tilbage og tilføj spillere først.', '#FF9A42');
                setTimeout(() => {
                    if (confirm('Ingen spillere fundet. Vil du gå tilbage til spillere-siden?')) {
                        window.location.href = 'index.html';
                    }
                }, 2000);
            }
        }

        function updateTeamNamesGrid() {
            if (teams.length === 0) {
                teamNamesGrid.innerHTML = '<p>Initialiserer hold...</p>';
                return;
            }
            
            teamNamesGrid.innerHTML = teams.map((team, index) => `
                <div class="team-name-input">
                    <label for="teamName${index}">Hold ${index + 1}:</label>
                    <input type="text" id="teamName${index}" value="${escapeHtml(team.name)}" 
                           onchange="updateTeamName(${index}, this.value)" maxlength="20">
                </div>
            `).join('');
        }

        function updateTeamsGrid() {
            if (teams.length === 0) {
                teamsGrid.innerHTML = '<p>Initialiserer hold...</p>';
                return;
            }
            
            teamsGrid.innerHTML = teams.map((team, index) => `
                <div class="team-card">
                    <div class="team-header">
                        <div class="team-info">
                            <div class="team-color-indicator team-${index + 1}-color"></div>
                            <span class="team-name">${escapeHtml(team.name)}</span>
                        </div>
                        <span class="team-count">${team.players.length}</span>
                    </div>
                    <div class="team-players ${team.players.length === 0 ? 'empty' : ''}" 
                         data-team-id="${team.id}"
                         ondrop="dropPlayer(event, ${team.id})"
                         ondragover="allowDrop(event)">
                        ${team.players.map(player => `
                            <div class="player-chip in-team-${index + 1}" 
                                 draggable="true" 
                                 data-player-id="${player.id}"
                                 ondragstart="dragStart(event, '${player.id}')">
                                ${escapeHtml(player.name)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updatePlayersPool() {
            const unassignedPlayers = getUnassignedPlayers();
            
            if (unassignedPlayers.length === 0) {
                playersPool.innerHTML = '';
                playersPool.classList.add('empty');
            } else {
                playersPool.classList.remove('empty');
                playersPool.innerHTML = unassignedPlayers.map(player => `
                    <div class="player-chip" 
                         draggable="true" 
                         data-player-id="${player.id}"
                         ondragstart="dragStart(event, '${player.id}')">
                        ${escapeHtml(player.name)}
                    </div>
                `).join('');
            }
        }

        function updateUnassignedCount() {
            const count = getUnassignedPlayers().length;
            unassignedCount.textContent = count;
        }

        function updateContinueButton() {
            const unassignedCount = getUnassignedPlayers().length;
            
            if (unassignedCount === 0 && players.length > 0) {
                continueBtn.classList.remove('disabled');
                continueBtn.style.pointerEvents = 'auto';
                requirementText.textContent = 'Klar til at starte spil!';
            } else {
                continueBtn.classList.add('disabled');
                continueBtn.style.pointerEvents = 'none';
                if (players.length === 0) {
                    requirementText.textContent = 'Tilføj spillere først';
                } else {
                    requirementText.textContent = `${unassignedCount} spillere skal tildeles hold`;
                }
            }
        }

        function getUnassignedPlayers() {
            const assignedPlayerIds = teams.flatMap(team => team.players.map(p => p.id));
            return players.filter(player => !assignedPlayerIds.includes(player.id));
        }

        function updateTeamName(index, newName) {
            if (teams[index]) {
                teams[index].name = newName.trim() || `Hold ${index + 1}`;
                teamNames[index] = teams[index].name;
                saveData();
                updateTeamsGrid();
                showMessage(`Hold ${index + 1} omdøbt til "${teams[index].name}"`, '#4ECDC4');
            }
        }

        function shuffleTeams() {
            if (players.length === 0) {
                alert('Ingen spillere at blande');
                return;
            }
            
            if (teams.length === 0) {
                initializeTeams();
            }
            
            // Clear all teams
            teams.forEach(team => team.players = []);
            
            // Shuffle players
            const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
            
            // Distribute players evenly
            shuffledPlayers.forEach((player, index) => {
                const teamIndex = index % teams.length;
                teams[teamIndex].players.push(player);
            });
            
            saveData();
            updateUI();
            showMessage('Hold blandet!', '#4ECDC4');
        }

        function resetTeams() {
            if (teams.length === 0) {
                alert('Ingen hold at nulstille');
                return;
            }
            
            if (confirm('Nulstil alle hold? Alle spillere vil blive fjernet fra holdene.')) {
                teams.forEach(team => team.players = []);
                saveData();
                updateUI();
                showMessage('Hold nulstillet', '#FF9A42');
            }
        }

        // Drag and Drop functions
        function dragStart(event, playerId) {
            draggedPlayer = playerId;
            event.dataTransfer.setData('text/plain', playerId);
            
            const element = event.target;
            element.classList.add('dragging');
            
            setTimeout(() => {
                if (element.parentNode) {
                    element.style.opacity = '0.5';
                }
            }, 0);
        }

        function allowDrop(event) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function dropPlayer(event, teamId) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');
            
            const playerId = event.dataTransfer.getData('text/plain');
            if (!playerId) return;
            
            // Find the player
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            // Remove player from current team
            teams.forEach(team => {
                team.players = team.players.filter(p => p.id !== playerId);
            });
            
            // Add player to new team
            const targetTeam = teams.find(t => t.id === teamId);
            if (targetTeam) {
                targetTeam.players.push(player);
            }
            
            saveData();
            updateUI();
            showMessage(`${player.name} flyttet til ${targetTeam.name}`, '#4ECDC4');
        }

        // Handle drag end
        document.addEventListener('dragend', function(event) {
            const draggedElement = document.querySelector('.dragging');
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.opacity = '';
            }
            
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });

        function updateSyncStatus() {
            if (window.syncManager) {
                const status = window.syncManager.getStatus();
                
                if (!status.initialized) {
                    statusIndicator.textContent = '🔄';
                    statusText.textContent = 'Connecting...';
                    syncStatus.style.background = 'rgba(255, 179, 102, 0.3)';
                } else if (!status.hasSupabase) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                } else if (!status.online) {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Offline';
                    syncStatus.style.background = 'rgba(255, 154, 66, 0.3)';
                } else if (status.pendingSync > 0) {
                    statusIndicator.textContent = '⏳';
                    statusText.textContent = `Syncing ${status.pendingSync}...`;
                    syncStatus.style.background = 'rgba(69, 183, 209, 0.3)';
                } else if (status.hasSupabase && status.online) {
                    statusIndicator.textContent = '☁️';
                    statusText.textContent = 'Synced';
                    syncStatus.style.background = 'rgba(78, 205, 196, 0.3)';
                } else {
                    statusIndicator.textContent = '📱';
                    statusText.textContent = 'Local only';
                    syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
                }
            } else {
                statusIndicator.textContent = '📱';
                statusText.textContent = 'Local only';
                syncStatus.style.background = 'rgba(102, 102, 102, 0.3)';
            }
        }

        function showMessage(message, color) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) existingMessage.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideUp 0.3s ease forwards';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add animations
        if (!document.getElementById('teams-animations')) {
            const animationStyle = document.createElement('style');
            animationStyle.id = 'teams-animations';
            animationStyle.textContent = `
                @keyframes slideDown {
                    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    to { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
                
                @keyframes slideUp {
                    from { opacity: 1; transform: translateX(-50%) translateY(0); }
                    to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(animationStyle);
        }

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function() {
            if (teams.length > 0) {
                saveData();
            }
        });

        // Debug function
        window.debugTeams = function() {
            console.log('🔍 Debug Teams Data:');
            console.log('Players:', players);
            console.log('Teams:', teams);
            console.log('Local Storage Players:', localStorage.getItem('bakken-players'));
            console.log('Local Storage Teams:', localStorage.getItem('bakken-teams'));
            console.log('Is Data Loaded:', isDataLoaded);
        };
    </script>
</body>
</html>